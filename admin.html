<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - IHSS a tu Casa</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#003366',    // Azul Institucional
                            teal: '#0e7490',    // Acento
                            cyan: '#06b6d4',    // Vibrante
                            clinical: '#10b981', // Verde √âxito
                            danger: '#ef4444',   // Rojo Alerta
                            light: '#f0fdfa'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        /* Custom Checkbox */
        .job-check { accent-color: #06b6d4; width: 16px; height: 16px; cursor: pointer; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        
        /* Select Multiple Mejorado */
        select[multiple] { background-image: none; padding: 0.5rem; height: 140px; }
        select[multiple] option { padding: 8px; border-radius: 6px; margin-bottom: 4px; border: 1px solid #f1f5f9; transition: all 0.2s; }
        select[multiple] option:checked { background-color: #06b6d4; color: white; border-color: #0891b2; font-weight: 500; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden text-slate-700 bg-slate-50">

    <!-- PANTALLA DE BLOQUEO -->
    <div id="auth-lock" class="fixed inset-0 z-50 bg-[#003366] flex flex-col items-center justify-center text-white hidden fade-in">
        <div class="bg-white p-3 rounded-full mb-5 shadow-2xl ring-4 ring-white/10">
            <img src="https://portal.ihss.hn/cronicos/assets/dist/img/Recurso%201.png" class="h-20 w-20 object-contain">
        </div>
        <h2 class="text-3xl font-bold mb-2 tracking-tight">Sesi√≥n Finalizada</h2>
        <p class="text-blue-200 text-sm mb-8 max-w-xs text-center leading-relaxed" id="lock-msg">Tu sesi√≥n ha expirado.</p>
        <button onclick="forceNavigateLogin()" class="bg-brand-cyan hover:bg-brand-teal text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg transform hover:scale-105 flex items-center mb-4">
            <i class="fa-solid fa-arrow-left mr-3"></i> Ir al Login
        </button>
        <button onclick="document.getElementById('auth-lock').classList.add('hidden')" class="text-[10px] text-white/30 hover:text-white/80 underline">Ocultar (Solo pruebas)</button>
    </div>

    <!-- SIDEBAR -->
    <aside class="w-full md:w-72 bg-brand-dark text-white flex flex-col shadow-2xl z-20 shrink-0 relative">
        <div class="p-6 border-b border-blue-900/50 flex flex-col items-center text-center">
            <div class="bg-white p-1 rounded-full shadow-lg mb-3 w-16 h-16 flex items-center justify-center ring-2 ring-brand-cyan/50">
                <img src="https://portal.ihss.hn/cronicos/assets/dist/img/Recurso%201.png" class="object-contain h-full w-full p-1">
            </div>
            <h2 class="font-bold text-lg tracking-wide text-white">ADMINISTRACI√ìN</h2>
            <p class="text-[10px] text-brand-cyan uppercase tracking-wider mb-2">Panel de Control</p>
            <div class="flex items-center bg-black/20 px-3 py-1 rounded-full border border-white/10 mt-2">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-brand-clinical animate-pulse mr-2"></span>
                <span id="status-text" class="text-[10px] font-bold text-emerald-300 uppercase">Sistema Online</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
            <button class="w-full flex items-center space-x-3 p-3 bg-white/10 rounded-xl text-white border-l-4 border-brand-cyan shadow-lg">
                <i class="fa-solid fa-users-gear text-brand-cyan w-5"></i><span class="font-medium text-sm">Gesti√≥n de Usuarios</span>
            </button>
        </nav>
        <div class="p-4 bg-black/20 border-t border-white/5">
            <button onclick="logout()" class="w-full bg-red-500/20 hover:bg-red-600 text-red-100 py-2 rounded-lg text-xs font-bold uppercase transition flex items-center justify-center group">
                <i class="fa-solid fa-power-off mr-2 group-hover:scale-110 transition-transform"></i> Cerrar Sesi√≥n
            </button>
        </div>
    </aside>

    <!-- CONTENIDO -->
    <main class="flex-1 overflow-hidden flex flex-col bg-slate-50 relative">
        <header class="bg-white shadow-sm border-b border-slate-200 p-6 flex justify-between items-center z-10">
            <div><h1 class="text-2xl font-bold text-brand-dark">Directorio de Personal</h1><p class="text-xs text-slate-500">Administra departamentos, roles y seguridad.</p></div>
            <button onclick="openModal()" class="bg-brand-dark hover:bg-brand-cyan text-white px-6 py-2.5 rounded-xl font-bold shadow-lg shadow-blue-900/20 transition-all transform hover:-translate-y-1 flex items-center text-sm"><i class="fa-solid fa-user-plus mr-2"></i> Nuevo Usuario</button>
        </header>

        <div class="flex-1 overflow-y-auto p-6 md:p-8 custom-scroll">
            <!-- Stats -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center"><div class="w-12 h-12 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center text-xl mr-4"><i class="fa-solid fa-users"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold">Total Personal</p><h4 class="text-2xl font-bold text-slate-700" id="stat-total">0</h4></div></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center"><div class="w-12 h-12 rounded-full bg-emerald-50 text-emerald-600 flex items-center justify-center text-xl mr-4"><i class="fa-solid fa-sitemap"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold">Departamentos</p><h4 class="text-2xl font-bold text-slate-700">7</h4></div></div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-100 flex items-center"><div class="w-12 h-12 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center text-xl mr-4"><i class="fa-solid fa-shield-cat"></i></div><div><p class="text-xs text-slate-400 uppercase font-bold">Seguridad IP</p><h4 class="text-2xl font-bold text-slate-700" id="stat-security">0</h4></div></div>
            </div>

            <!-- Tabla -->
            <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-[11px] uppercase text-slate-500 font-semibold tracking-wider">
                            <tr>
                                <th class="p-5 pl-6">Colaborador (DNI)</th>
                                <th class="p-5">Departamento & Cargos</th>
                                <th class="p-5">Acceso</th>
                                <th class="p-5 text-center">Estatus</th>
                                <th class="p-5 pr-6 text-right">Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="user-list" class="divide-y divide-slate-100 text-sm text-slate-600">
                            <tr><td colspan="5" class="p-8 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Cargando directorio...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAL (FORMULARIO) -->
    <div id="userModal" class="fixed inset-0 modal-backdrop hidden z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-3xl transform transition-all fade-in overflow-hidden max-h-[90vh] flex flex-col">
            <div class="bg-brand-dark p-5 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold text-lg flex items-center"><i class="fa-solid fa-id-badge mr-2"></i> <span id="modalTitle">Gesti√≥n de Personal</span></h3>
                <button onclick="closeModal()" class="text-white/70 hover:text-white transition"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            
            <div class="p-6 overflow-y-auto custom-scroll">
                <form id="userForm" class="space-y-6">
                    <input type="hidden" id="editUid">

                    <!-- Identidad -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">DNI (C√©dula)</label>
                            <input type="text" id="formDni" class="w-full border border-slate-300 rounded-lg p-2.5 focus:border-brand-cyan focus:ring-2 focus:ring-brand-cyan/20 outline-none" required placeholder="Ej: 0801-1990-12345">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Nombre Completo</label>
                            <input type="text" id="formName" class="w-full border border-slate-300 rounded-lg p-2.5 focus:border-brand-cyan focus:ring-2 focus:ring-brand-cyan/20 outline-none" required placeholder="Ej: Dra. Ana L√≥pez">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Usuario Sistema</label>
                            <input type="text" id="formUser" class="w-full border border-slate-300 rounded-lg p-2.5 bg-slate-50 focus:bg-white focus:border-brand-cyan outline-none font-mono text-sm" required placeholder="alopez">
                        </div>
                        <div class="col-span-2 md:col-span-1">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Contrase√±a</label>
                            <input type="password" id="formPass" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none focus:border-brand-cyan" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                            <p class="text-[10px] text-slate-400 mt-1" id="passHelp">M√≠nimo 6 caracteres.</p>
                        </div>
                    </div>

                    <hr class="border-slate-100">

                    <!-- Roles Din√°micos (MultiSelect) -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Departamento</label>
                            <select id="formDept" onchange="updateRoles()" class="w-full border border-slate-300 rounded-lg p-2.5 outline-none focus:border-brand-cyan bg-white appearance-none cursor-pointer">
                                <option value="" disabled selected>Seleccione Departamento...</option>
                                <option value="farmacia">üíä Farmacia</option>
                                <option value="contact_center">üéß Contact Center</option>
                                <option value="operaciones">‚öôÔ∏è Operaciones</option>
                                <option value="calidad">‚úÖ Calidad y Sellado</option>
                                <option value="logistica">üì¶ Log√≠stica</option>
                                <option value="repartidor">üõµ Delivery (Reparto)</option>
                                <option value="admin">üõ°Ô∏è Administraci√≥n</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-1">Cargos / Funciones (Multi-Selecci√≥n)</label>
                            <select id="formJob" multiple class="w-full border border-slate-300 rounded-lg outline-none focus:border-brand-cyan bg-white text-sm cursor-pointer shadow-inner">
                                <option disabled>Seleccione Dept. primero...</option>
                            </select>
                            <p class="text-[10px] text-brand-cyan mt-1 ml-1 font-medium"><i class="fa-solid fa-circle-info mr-1"></i>Mant√©n Ctrl/Cmd para seleccionar varios.</p>
                        </div>
                    </div>

                    <!-- Seguridad -->
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100">
                        <h4 class="text-xs font-bold text-brand-dark uppercase mb-3 flex items-center"><i class="fa-solid fa-lock mr-2"></i> Control de Acceso</h4>
                        <div class="flex items-center justify-between mb-4">
                            <div class="mr-4"><span class="text-sm font-semibold text-slate-700 block">Validaci√≥n de Dispositivo</span><span class="text-xs text-slate-500">Requiere aprobaci√≥n IP.</span></div>
                            <label class="relative inline-flex items-center cursor-pointer"><input type="checkbox" id="formIpCheck" class="sr-only peer"><div class="w-11 h-6 bg-slate-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-clinical"></div></label>
                        </div>
                        <div class="border-t border-slate-200/60 pt-3">
                            <label class="block text-xs font-bold text-slate-500 uppercase mb-2">D√≠as Permitidos</label>
                            <div class="flex flex-wrap gap-2 mb-3">
                                <label class="cursor-pointer bg-white border px-3 py-1 rounded hover:border-brand-cyan transition"><input type="checkbox" class="mr-1 day-check" value="Lunes"> L</label>
                                <label class="cursor-pointer bg-white border px-3 py-1 rounded hover:border-brand-cyan transition"><input type="checkbox" class="mr-1 day-check" value="Martes"> M</label>
                                <label class="cursor-pointer bg-white border px-3 py-1 rounded hover:border-brand-cyan transition"><input type="checkbox" class="mr-1 day-check" value="Miercoles"> X</label>
                                <label class="cursor-pointer bg-white border px-3 py-1 rounded hover:border-brand-cyan transition"><input type="checkbox" class="mr-1 day-check" value="Jueves"> J</label>
                                <label class="cursor-pointer bg-white border px-3 py-1 rounded hover:border-brand-cyan transition"><input type="checkbox" class="mr-1 day-check" value="Viernes"> V</label>
                                <label class="cursor-pointer bg-white border px-3 py-1 rounded hover:border-brand-cyan transition"><input type="checkbox" class="mr-1 day-check" value="Sabado"> S</label>
                                <label class="cursor-pointer bg-white border px-3 py-1 rounded hover:border-brand-cyan transition"><input type="checkbox" class="mr-1 day-check" value="Domingo"> D</label>
                            </div>
                            <div class="flex items-center gap-3"><input type="time" id="formStart" class="border p-1.5 rounded text-xs bg-white"><span class="text-xs">a</span><input type="time" id="formEnd" class="border p-1.5 rounded text-xs bg-white"></div>
                        </div>
                    </div>
                </form>
            </div>

            <div class="p-5 border-t border-slate-100 bg-slate-50 flex justify-end gap-3 shrink-0">
                <button type="button" onclick="closeModal()" class="px-5 py-2.5 text-sm font-bold text-slate-500 hover:text-slate-700 transition">Cancelar</button>
                <button type="button" onclick="saveUser()" id="btnSave" class="bg-brand-clinical hover:bg-emerald-600 text-white px-6 py-2.5 rounded-lg text-sm font-bold shadow-lg shadow-emerald-200 transition transform active:scale-95 flex items-center"><i class="fa-solid fa-save mr-2"></i> Guardar Usuario</button>
            </div>
        </div>
    </div>

    <!-- SCRIPT -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, onSnapshot, updateDoc, deleteDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        // Configuraci√≥n
        const firebaseConfig = { apiKey: "AIzaSyC2HWoYjIltPqkysduZ-954-f-kZCFaNdA", authDomain: "fdihss.firebaseapp.com", projectId: "fdihss", storageBucket: "fdihss.firebasestorage.app", messagingSenderId: "1004594046776", appId: "1:1004594046776:web:164dcdb2b023b8719283cd" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "fdihss-mediflow-v2-modular";
        const DOMAIN_SUFFIX = "@mediflow.sys"; 
        
        // App Secundaria para crear usuarios sin logout
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        // --- MANEJO DE ESTATUS ONLINE/OFFLINE ---
        async function setUserStatus(uid, status) {
            try {
                // 1. Actualizar perfil privado
                const userRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
                await updateDoc(userRef, { status: status });
                
                // 2. Actualizar directorio p√∫blico (buscando el documento correcto)
                const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), where('uid', '==', uid));
                const snapshot = await getDocs(q);
                snapshot.forEach(async (docSnap) => {
                    await updateDoc(docSnap.ref, { status: status });
                });
            } catch (e) { console.error("Error updating status:", e); }
        }

        const roleDefinitions = {
            'farmacia': [ { val: 'Supervisor de Farmacia', label: 'Supervisor General' }, { val: 'Revisi√≥n y Asignaci√≥n', label: 'Revisor de Pacientes' }, { val: 'Despacho de Medicamentos', label: 'Despacho (Salida)' }, { val: 'Gesti√≥n de Inventario', label: 'Gesti√≥n de Inventario' } ],
            'contact_center': [ { val: 'Supervisor CC', label: 'Supervisor' }, { val: 'Agente Contact Center', label: 'Agente Telef√≥nico' } ],
            'operaciones': [ { val: 'Supervisor Operaciones', label: 'Supervisor' }, { val: 'Operador', label: 'Operador de Sistema' } ],
            'calidad': [ { val: 'Supervisor Calidad', label: 'Supervisor Calidad' }, { val: 'Revisor de Paquetes', label: 'Revisor (Contenido)' }, { val: 'Controlador Observaciones', label: 'Control de Observaciones' } ],
            'logistica': [ { val: 'Supervisor Log√≠stica', label: 'Supervisor General' }, { val: 'Asignador de Rutas', label: 'Asignador de Rutas' }, { val: 'Despachador Delivery', label: 'Despachador a Motoristas' } ],
            'repartidor': [ { val: 'Supervisor de Flota', label: 'Supervisor de Delivery' }, { val: 'Motorista', label: 'Motorista / Repartidor' } ],
            'admin': [ { val: 'Super Admin', label: 'Administrador Total' } ]
        };

        window.safeNavigate = (url) => {
            try { window.location.href = url; } 
            catch (e) { console.warn("Nav blocked:", e); if(url === 'index.html') showLockScreen("Redirecci√≥n bloqueada. Usa el bot√≥n."); } 
        };
        window.forceNavigateLogin = () => { try { window.location.href = 'index.html'; } catch(e) { alert("Recarga la p√°gina."); } };

        function showLockScreen(msg) {
            const lock = document.getElementById('auth-lock');
            if(lock) { document.getElementById('lock-msg').innerText = msg; lock.classList.remove('hidden'); }
        }

        window.updateRoles = (selectedJobs = []) => {
            const dept = document.getElementById('formDept').value;
            const select = document.getElementById('formJob');
            select.innerHTML = '';
            
            const jobsArr = Array.isArray(selectedJobs) ? selectedJobs : (selectedJobs ? [selectedJobs] : []);

            if (dept && roleDefinitions[dept]) {
                select.disabled = false;
                roleDefinitions[dept].forEach(role => {
                    const opt = document.createElement('option');
                    opt.value = role.val; opt.innerText = role.label;
                    if(jobsArr.includes(role.val)) opt.selected = true;
                    select.appendChild(opt);
                });
            } else { select.disabled = true; select.innerHTML = '<option disabled>Seleccione Dept. primero...</option>'; }
        };

        const updateStatus = (isOnline) => {
            const dot = document.getElementById('status-dot');
            const text = document.getElementById('status-text');
            if(dot && text) {
                if (isOnline) { dot.className = "w-2 h-2 rounded-full bg-brand-clinical animate-pulse mr-2 shadow-[0_0_8px_rgba(16,185,129,0.8)]"; text.innerText = "Sistema Online"; text.className = "text-[10px] font-bold text-emerald-300 uppercase tracking-widest"; } 
                else { dot.className = "w-2 h-2 rounded-full bg-red-500 mr-2"; text.innerText = "Desconectado"; text.className = "text-[10px] font-bold text-red-300 uppercase tracking-widest"; }
            }
        }
        window.addEventListener('online', () => updateStatus(true));
        window.addEventListener('offline', () => updateStatus(false));

        let inactivityTimer;
        let isTimeoutLogout = false;
        const TIMEOUT_LIMIT = 30 * 60 * 1000; 
        const resetInactivityTimer = () => {
            clearTimeout(inactivityTimer);
            if(auth.currentUser && document.getElementById('auth-lock').classList.contains('hidden')) {
               inactivityTimer = setTimeout(doInactivityLogout, TIMEOUT_LIMIT);
            }
        };
        const doInactivityLogout = async () => { 
            isTimeoutLogout = true; 
            if(auth.currentUser) await setUserStatus(auth.currentUser.uid, 'offline');
            await signOut(auth); 
        };
        ['mousemove', 'keydown', 'click', 'scroll'].forEach(evt => window.addEventListener(evt, resetInactivityTimer));

        onAuthStateChanged(auth, async (u) => { 
            if(window.isCreatingUser) return;

            if(!u) {
                let msg = "Debes iniciar sesi√≥n para acceder.";
                if(isTimeoutLogout) { msg = "Tu sesi√≥n ha expirado por inactividad (30 min)."; isTimeoutLogout = false; }
                showLockScreen(msg);
            } else { 
                try {
                    const s = await getDoc(doc(db,'artifacts',appId,'users',u.uid,'profile','data')); 
                    if(!s.exists() || s.data().role!=='admin') showLockScreen("Acceso Restringido. Rol no autorizado.");
                    else { 
                        // SESI√ìN ACTIVA: PONER ONLINE
                        await setUserStatus(u.uid, 'online');
                        resetInactivityTimer(); 
                        document.getElementById('auth-lock').classList.add('hidden'); 
                    }
                } catch(e) { console.error("Error Auth:", e); }
            }
        });

        window.openModal = (isEdit = false, userData = null) => {
            const modal = document.getElementById('userModal');
            document.getElementById('userForm').reset();
            
            if(isEdit && userData) {
                document.getElementById('modalTitle').innerText = "Editar Personal";
                document.getElementById('editUid').value = userData.uid;
                document.getElementById('formDni').value = userData.dni || ''; document.getElementById('formDni').disabled = false;
                document.getElementById('formName').value = userData.name;
                document.getElementById('formUser').value = userData.username; document.getElementById('formUser').disabled = true; 
                document.getElementById('formPass').placeholder = "(Sin cambios)";
                document.getElementById('formDept').value = userData.role; 
                updateRoles(userData.jobTitle); 
                document.getElementById('formIpCheck').checked = userData.requireIpApproval || false;
                document.getElementById('formStart').value = userData.shiftStart || '';
                document.getElementById('formEnd').value = userData.shiftEnd || '';
                if(userData.allowedDays) document.querySelectorAll('.day-check').forEach(cb => { if(userData.allowedDays.includes(cb.value)) cb.checked = true; });
            } else {
                document.getElementById('modalTitle').innerText = "Nuevo Ingreso";
                document.getElementById('editUid').value = "";
                document.getElementById('formDni').disabled = false;
                document.getElementById('formUser').disabled = false;
                document.getElementById('formPass').placeholder = "Requerido";
                updateRoles(); 
            }
            modal.classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('userModal').classList.add('hidden');

        window.saveUser = async () => {
            const btn = document.getElementById('btnSave');
            const editUid = document.getElementById('editUid').value;
            const dni = document.getElementById('formDni').value.trim(); 
            const name = document.getElementById('formName').value;
            const username = document.getElementById('formUser').value.trim().toLowerCase().replace(/\s+/g, '');
            const pass = document.getElementById('formPass').value;
            const dept = document.getElementById('formDept').value; 
            
            const jobSelect = document.getElementById('formJob');
            const jobTitles = Array.from(jobSelect.selectedOptions).map(opt => opt.value);

            const requireIp = document.getElementById('formIpCheck').checked;
            const start = document.getElementById('formStart').value;
            const end = document.getElementById('formEnd').value;
            const days = []; document.querySelectorAll('.day-check:checked').forEach(cb => days.push(cb.value));

            if(!dni || !name || !username || !dept || jobTitles.length === 0 || (!editUid && !pass)) { 
                alert("Por favor complete todos los campos obligatorios y seleccione al menos un Cargo."); return; 
            }

            const originalBtn = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Guardando...';
            btn.disabled = true;

            try {
                const userData = { dni, name, username, role: dept, jobTitle: jobTitles, requireIpApproval: requireIp, shiftStart: start, shiftEnd: end, allowedDays: days, lastUpdated: new Date().toISOString() };

                if (editUid) {
                    await updateDoc(doc(db,'artifacts',appId,'users',editUid,'profile','data'), userData);
                    // Actualizar directorio p√∫blico (Simulaci√≥n por falta de ID directo en UI)
                    // Para que se vea en tiempo real, buscamos y actualizamos:
                    const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), where('uid', '==', editUid));
                    const snapshot = await getDocs(q);
                    snapshot.forEach(async (docSnap) => {
                        await updateDoc(docSnap.ref, userData);
                    });
                    
                    alert("Datos actualizados correctamente.");
                } else {
                    if(!confirm("‚ö†Ô∏è ¬øCrear nuevo usuario?\n(La sesi√≥n de Admin NO se cerrar√°).")) { btn.innerHTML = originalBtn; btn.disabled = false; return; }
                    
                    const email = username + DOMAIN_SUFFIX;
                    
                    // CREAR CON AUTH SECUNDARIO (Sin cerrar sesi√≥n admin)
                    const cred = await createUserWithEmailAndPassword(secondaryAuth, email, pass);
                    await signOut(secondaryAuth); // Cerrar sesi√≥n secundaria limpia

                    userData.uid = cred.user.uid; userData.createdAt = new Date().toISOString(); userData.status = "offline"; // Empieza offline
                    
                    await setDoc(doc(db,'artifacts',appId,'users',cred.user.uid,'profile','data'), userData);
                    await addDoc(collection(db,'artifacts',appId,'public','data','users_directory'), userData);
                    
                    alert(`‚úÖ Usuario "${username}" creado exitosamente.`);
                }
                closeModal(); 
            } catch (err) { 
                console.error(err);
                let msg = err.message;
                if(msg.includes("email-already-in-use")) msg = "El nombre de usuario ya existe.";
                alert("Error: " + msg); 
            } finally {
                btn.innerHTML = originalBtn; btn.disabled = false; 
            }
        };

        window.deleteUser = async (docId, uid, name) => {
            if(!confirm(`¬øDar de baja a ${name}?`)) return;
            try {
                await deleteDoc(doc(db,'artifacts',appId,'public','data','users_directory', docId));
                await deleteDoc(doc(db,'artifacts',appId,'users',uid,'profile','data'));
                alert("Usuario dado de baja.");
            } catch(e) { alert("Error: " + e.message); }
        };

        onSnapshot(collection(db,'artifacts',appId,'public','data','users_directory'), (s) => {
            const list = document.getElementById('user-list');
            const totalEl = document.getElementById('stat-total');
            
            if(totalEl) totalEl.innerText = s.size;

            if (list) {
                list.innerHTML = '';
                if (s.empty) { list.innerHTML = '<tr><td colspan="5" class="p-8 text-center text-slate-400 italic bg-slate-50 border-t border-slate-200">Directorio vac√≠o. Comience agregando usuarios.</td></tr>'; return; }

                s.forEach(docSnap => {
                    const u = docSnap.data();
                    const docId = docSnap.id;
                    const link = `${window.location.origin}/index.html?u=${u.username}`;
                    const userObj = JSON.stringify(u).replace(/"/g, '&quot;');
                    
                    let colorClass = 'bg-slate-100 text-slate-600 border-slate-200';
                    let iconClass = 'fa-user';
                    if(u.role === 'admin') { colorClass = 'bg-red-50 text-red-600 border-red-100'; iconClass='fa-shield-halved'; }
                    else if(u.role === 'farmacia') { colorClass = 'bg-emerald-50 text-emerald-600 border-emerald-100'; iconClass='fa-pills'; }
                    else if(u.role === 'logistica') { colorClass = 'bg-orange-50 text-orange-600 border-orange-100'; iconClass='fa-truck-fast'; }
                    else if(u.role === 'contact_center') { colorClass = 'bg-blue-50 text-blue-600 border-blue-100'; iconClass='fa-headset'; }

                    // Renderizar cargos multiples
                    const jobs = Array.isArray(u.jobTitle) ? u.jobTitle : [u.jobTitle || 'General'];
                    const jobsDisplay = jobs.map(j => `<div class="text-[10px] text-slate-500 bg-slate-50 border border-slate-100 px-1.5 py-0.5 rounded mb-0.5 w-fit">${j}</div>`).join('');

                    // L√≥gica visual de estatus ONLINE/OFFLINE
                    const isOnline = u.status === 'online';
                    const statusBadge = isOnline 
                        ? `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold bg-emerald-100 text-emerald-700 border border-emerald-200 shadow-sm"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500 animate-pulse mr-1.5"></span> ONLINE</span>`
                        : `<span class="inline-flex items-center px-2.5 py-1 rounded-full text-[10px] font-bold bg-red-50 text-red-400 border border-red-100"><span class="w-1.5 h-1.5 rounded-full bg-red-400 mr-1.5"></span> OFFLINE</span>`;


                    list.innerHTML += `
                        <tr class="hover:bg-blue-50/40 transition border-b border-slate-50 last:border-0 group cursor-default">
                            <td class="p-5 pl-6">
                                <div class="flex items-center">
                                    <div class="w-10 h-10 rounded-xl bg-white border border-slate-100 shadow-sm flex items-center justify-center text-sm font-bold text-brand-dark mr-3 uppercase shrink-0">${u.name.charAt(0)}</div>
                                    <div><div class="font-bold text-slate-700 text-sm">${u.name}</div><div class="text-[11px] text-slate-400 font-mono flex items-center mt-0.5"><i class="fa-regular fa-id-card mr-1 opacity-70"></i>${u.dni || '---'}</div></div>
                                </div>
                            </td>
                            <td class="p-5">
                                <div class="flex flex-col items-start">
                                    <span class="${colorClass} border px-2 py-0.5 rounded text-[10px] font-bold uppercase mb-1.5 inline-flex items-center shadow-sm"><i class="fa-solid ${iconClass} mr-1.5 opacity-70"></i> ${u.role.replace('_',' ')}</span>
                                    <div class="flex flex-col gap-0.5">${jobsDisplay}</div>
                                </div>
                            </td>
                            <td class="p-5"><div class="space-y-1.5"><div class="text-xs font-mono text-slate-500 bg-slate-100/80 px-2 py-1 rounded w-fit border border-slate-200"><i class="fa-solid fa-user mr-1.5 text-slate-400"></i>${u.username}</div></div></td>
                            <td class="p-5 text-center">${statusBadge}</td>
                            <td class="p-5 pr-6 text-right">
                                <div class="flex justify-end gap-2 opacity-60 group-hover:opacity-100 transition-opacity">
                                    <button onclick="prompt('Enlace de Acceso √önico:', '${link}')" class="w-8 h-8 rounded-lg bg-slate-50 text-slate-500 hover:bg-slate-200 hover:text-slate-700 transition flex items-center justify-center border border-slate-200" title="Copiar Enlace"><i class="fa-solid fa-link"></i></button>
                                    <button onclick="openModal(true, ${userObj})" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition flex items-center justify-center border border-blue-100 shadow-sm" title="Editar"><i class="fa-solid fa-pen"></i></button>
                                    <button onclick="deleteUser('${docId}', '${u.uid}', '${u.name}')" class="w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center border border-red-100 shadow-sm" title="Baja"><i class="fa-solid fa-trash"></i></button>
                                </div>
                            </td>
                        </tr>`;
                });
            }
        });

        window.logout = () => { 
            if(confirm("¬øCerrar sesi√≥n de administrador?")) {
                if(auth.currentUser) setUserStatus(auth.currentUser.uid, 'offline'); // Poner offline antes de salir
                signOut(auth).then(() => safeNavigate('index.html')); 
            }
        };
    </script>
</body>
</html>

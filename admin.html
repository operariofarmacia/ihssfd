<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Administraci√≥n - IHSS a tu Casa</title>
    <!-- Librer√≠as Externas -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#003366', teal: '#0e7490', cyan: '#06b6d4', clinical: '#10b981', danger: '#ef4444', light: '#f8fafc'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hidden-view { display: none !important; }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); }
        .calendar-day { min-height: 110px; transition: all 0.2s; border-radius: 12px; border: 1px solid #e2e8f0; position: relative; }
        .calendar-day:hover { background-color: #f0f9ff; border-color: #06b6d4; }
        
        .timeline-step { position: relative; z-index: 1; min-width: 45px; }
        .timeline-step::before { content: ''; position: absolute; top: 9px; left: -50%; width: 100%; height: 2px; background: #e2e8f0; z-index: -1; }
        .timeline-step:first-child::before { display: none; }
        .timeline-active .step-dot { background-color: #10b981; color: white; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        .timeline-active::before { background: #10b981; }
        
        .tab-btn.active { border-bottom: 3px solid #003366; color: #003366; font-weight: 700; background-color: #f1f5f9; }
        .tab-btn { color: #64748b; transition: all 0.2s; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden text-slate-700 bg-slate-50">

    <!-- BLOQUE 0: SEGURIDAD Y BLOQUEO -->
    <div id="auth-lock" class="fixed inset-0 z-[200] bg-[#003366] flex flex-col items-center justify-center text-white hidden fade-in">
        <div class="bg-white p-3 rounded-full mb-5 shadow-2xl ring-4 ring-white/10">
            <img src="https://portal.ihss.hn/cronicos/assets/dist/img/Recurso%201.png" class="h-20 w-20 object-contain">
        </div>
        <h2 class="text-3xl font-bold mb-2 tracking-tight">Sesi√≥n Finalizada</h2>
        <p class="text-blue-200 text-sm mb-8 max-w-xs text-center leading-relaxed" id="lock-msg">Por seguridad o inactividad, su sesi√≥n ha sido cerrada.</p>
        <button onclick="forceNavigateLogin()" class="bg-brand-cyan hover:bg-brand-teal text-white px-8 py-3 rounded-xl font-bold shadow-lg transition-transform transform active:scale-95 flex items-center">
            <i class="fa-solid fa-arrow-left mr-3"></i> Regresar al Acceso
        </button>
    </div>

    <!-- BLOQUE 1: SIDEBAR -->
    <aside class="w-full md:w-72 bg-brand-dark text-white flex flex-col shadow-2xl z-20 shrink-0 relative">
        <div class="p-6 border-b border-blue-900/50 flex flex-col items-center text-center">
            <div class="bg-white p-1 rounded-full shadow-lg mb-3 w-16 h-16 flex items-center justify-center ring-2 ring-brand-cyan/50 cursor-pointer hover:scale-105 transition-transform" onclick="switchView('dashboard')">
                <img src="https://portal.ihss.hn/cronicos/assets/dist/img/Recurso%201.png" class="object-contain h-full w-full p-1">
            </div>
            <h2 class="font-bold text-lg tracking-wide uppercase">Administraci√≥n</h2>
            <div class="flex items-center bg-black/20 px-3 py-1 rounded-full border border-white/10 mt-2">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-brand-clinical animate-pulse mr-2"></span>
                <span id="status-text" class="text-[10px] font-bold text-emerald-300 uppercase">Sistema Online</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scroll">
            <button onclick="switchView('dashboard')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition" id="btn-view-dashboard">
                <i class="fa-solid fa-house w-5 text-center"></i><span class="font-medium text-sm">Inicio</span>
            </button>
            <div class="pt-4 pb-2 px-3 text-[10px] text-slate-400 font-bold uppercase tracking-wider">M√≥dulos</div>
            <button onclick="switchView('users')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition" id="btn-view-users">
                <i class="fa-solid fa-users-gear w-5 text-center"></i><span class="font-medium text-sm">Personal</span>
            </button>
            <button onclick="switchView('beneficiaries')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition" id="btn-view-beneficiaries">
                <i class="fa-solid fa-hospital-user w-5 text-center"></i><span class="font-medium text-sm">Derechohabientes</span>
            </button>
            <button onclick="switchView('shipments')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition" id="btn-view-shipments">
                <i class="fa-solid fa-truck-fast w-5 text-center"></i><span class="font-medium text-sm">Log√≠stica</span>
            </button>
        </nav>
        <div class="p-4 bg-black/20 border-t border-white/5">
            <button onclick="logout()" class="w-full bg-red-500/20 hover:bg-red-600 text-red-100 py-2.5 rounded-lg text-xs font-bold uppercase transition flex items-center justify-center group">
                <i class="fa-solid fa-power-off mr-2 group-hover:scale-110 transition-transform"></i> Cerrar Sesi√≥n
            </button>
        </div>
    </aside>

    <main class="flex-1 overflow-hidden flex flex-col bg-slate-50 relative">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="flex-1 flex flex-col h-full overflow-hidden fade-in">
            <header class="bg-white shadow-sm border-b border-slate-200 p-8 shrink-0">
                <h1 class="text-3xl font-bold text-brand-dark mb-1 tracking-tight">Consola Administrativa</h1>
                <p class="text-slate-500 text-sm">Sistema Central de IHSS a tu Casa.</p>
            </header>
            <div class="flex-1 overflow-y-auto p-8 custom-scroll">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div onclick="switchView('users')" class="dash-card bg-white rounded-3xl p-8 border border-slate-100 shadow-sm cursor-pointer group">
                        <div class="w-16 h-16 rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-user-shield"></i></div>
                        <h3 class="font-bold text-slate-700 text-lg">Personal</h3>
                        <p class="text-xs text-slate-400">Directorio y seguridad</p>
                    </div>
                    <div onclick="switchView('beneficiaries')" class="dash-card bg-white rounded-3xl p-8 border border-slate-100 shadow-sm cursor-pointer group">
                        <div class="w-16 h-16 rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-hospital-user"></i></div>
                        <h3 class="font-bold text-slate-700 text-lg">Pacientes</h3>
                        <p class="text-xs text-slate-400">Derechohabientes y Carga CSV</p>
                    </div>
                    <div onclick="switchView('shipments')" class="dash-card bg-white rounded-3xl p-8 border border-slate-100 shadow-sm cursor-pointer group">
                        <div class="w-16 h-16 rounded-2xl bg-cyan-50 text-brand-cyan flex items-center justify-center text-3xl mb-4 group-hover:scale-110 transition-transform"><i class="fa-solid fa-map-location-dot"></i></div>
                        <h3 class="font-bold text-slate-700 text-lg">Log√≠stica</h3>
                        <p class="text-xs text-slate-400">Monitoreo de rutas</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- GESTI√ìN PERSONAL (MODULO USUARIOS) -->
        <div id="view-users" class="hidden-view flex-1 flex flex-col h-full overflow-hidden fade-in">
            <header class="bg-white shadow-sm border-b border-slate-200 p-6 flex justify-between items-center shrink-0">
                <h1 class="text-2xl font-bold text-brand-dark">Colaboradores</h1>
                <div class="flex gap-2">
                    <button onclick="balanceWorkload()" class="bg-indigo-50 hover:bg-indigo-100 text-indigo-600 border border-indigo-200 px-4 py-2 rounded-xl font-bold text-xs">‚öñÔ∏è Equilibrar Cargas</button>
                    <button onclick="openUserModal()" class="bg-brand-dark hover:bg-brand-cyan text-white px-6 py-2.5 rounded-xl font-bold shadow-lg text-sm transition-all"><i class="fa-solid fa-user-plus mr-2"></i> Nuevo Usuario</button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 custom-scroll">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left border-collapse">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-500 font-bold">
                            <tr><th class="p-5 pl-6">Colaborador</th><th class="p-5">Roles</th><th class="p-5">Acceso</th><th class="p-5 text-center">Estatus</th><th class="p-5 pr-6 text-right">Acciones</th></tr>
                        </thead>
                        <tbody id="user-list" class="divide-y divide-slate-100 text-sm"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- GESTI√ìN DERECHOHABIENTES (MODULO PACIENTES + CSV) -->
        <div id="view-beneficiaries" class="hidden-view flex-1 flex flex-col h-full overflow-hidden fade-in">
            <header class="bg-white shadow-sm border-b border-slate-200 p-6 flex justify-between items-center shrink-0">
                <h1 class="text-2xl font-bold text-brand-dark">Derechohabientes</h1>
                <div class="flex gap-3">
                    <div id="csvStatus" class="hidden flex items-center text-xs font-bold text-brand-clinical animate-pulse mr-2"><i class="fa-solid fa-sync fa-spin mr-1"></i> Cargando datos...</div>
                    <label class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg cursor-pointer flex items-center text-sm transition-all">
                        <i class="fa-solid fa-file-csv mr-2 text-lg"></i> IMPORTAR CSV
                        <input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleCSVUpload(this)">
                    </label>
                    <button onclick="openBeneficiaryModal()" class="bg-brand-dark hover:bg-brand-cyan text-white px-5 py-2.5 rounded-xl font-bold shadow-lg flex items-center text-sm transition-all"><i class="fa-solid fa-plus mr-2"></i> Crear Manual</button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 custom-scroll">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <table class="w-full text-left border-collapse text-sm text-slate-600">
                        <thead class="bg-slate-50 text-[10px] uppercase text-slate-500 font-bold">
                            <tr><th class="p-5 pl-6">Paciente</th><th class="p-5">Tipo</th><th class="p-5">Entrega</th><th class="p-5">Gestores</th><th class="p-5 pr-6 text-right">Acciones</th></tr>
                        </thead>
                        <tbody id="ben-list" class="divide-y divide-slate-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- LOG√çSTICA (MODULO ENV√çOS) -->
        <div id="view-shipments" class="hidden-view flex-1 flex flex-col h-full overflow-hidden fade-in">
            <header class="bg-white shadow-sm border-b border-slate-200 p-6 flex justify-between items-center shrink-0">
                <div>
                    <h1 class="text-2xl font-bold text-brand-dark flex items-center"><i class="fa-solid fa-truck-ramp-box mr-3 text-brand-cyan"></i> Log√≠stica IHSS</h1>
                    <nav class="flex text-[10px] text-slate-500 mt-1 font-bold" id="ship-breadcrumb"><span class="cursor-pointer hover:underline" onclick="resetShipView()">Inicio</span></nav>
                </div>
            </header>
            <div class="flex flex-col md:flex-row h-full overflow-hidden">
                <div class="flex-1 overflow-y-auto p-6 custom-scroll bg-slate-50/50">
                    <div id="ship-years" class="grid grid-cols-1 md:grid-cols-4 gap-6">
                        <div onclick="openYear(2026)" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:border-brand-cyan hover:shadow-xl cursor-pointer text-center group transition-all">
                            <div class="text-4xl font-bold text-brand-dark group-hover:text-brand-cyan mb-2 transition-colors">2026</div><p class="text-xs text-slate-400 uppercase tracking-widest font-bold">A√±o Fiscal</p>
                        </div>
                    </div>
                    <div id="ship-months" class="hidden grid grid-cols-1 md:grid-cols-4 gap-4 fade-in"></div>
                    <div id="ship-days" class="hidden fade-in"><div class="bg-white rounded-3xl shadow-sm border border-slate-200 p-6"><div class="grid grid-cols-7 gap-2 mb-2 text-center text-[10px] font-bold text-slate-400 uppercase"><div>Dom</div><div>Lun</div><div>Mar</div><div>Mi√©</div><div>Jue</div><div>Vie</div><div>S√°b</div></div><div id="calendar-grid" class="grid grid-cols-7 gap-2"></div></div></div>
                </div>
                <!-- Panel Lateral IA -->
                <aside class="w-full md:w-80 bg-white border-l border-slate-200 shadow-xl flex flex-col z-20">
                    <div class="p-5 border-b border-slate-100 bg-brand-light">
                        <h3 class="font-bold text-brand-teal flex items-center text-sm uppercase tracking-wider"><i class="fa-solid fa-robot mr-2 text-brand-cyan"></i> Planificador IA</h3>
                    </div>
                    <div class="flex-1 overflow-y-auto p-4 custom-scroll" id="ai-suggestions-list">
                        <div class="text-center py-10 px-4">
                            <button onclick="runAIScheduler()" class="bg-brand-cyan hover:bg-brand-teal text-white px-6 py-2.5 rounded-full font-bold shadow-lg transition-transform transform active:scale-95 text-xs w-full mb-4">
                                <i class="fa-solid fa-wand-magic-sparkles mr-2"></i> ANALIZAR PR√ìXIMO MES
                            </button>
                            <p class="text-[10px] text-slate-400">Analiza historiales y ciclos de recetas para programar env√≠os futuros.</p>
                        </div>
                    </div>
                </aside>
            </div>
        </div>

    </main>

    <!-- MODAL: USUARIO -->
    <div id="userModal" class="fixed inset-0 modal-backdrop hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-3xl flex flex-col max-h-[90vh] shadow-2xl">
            <div class="bg-brand-dark p-6 text-white flex justify-between items-center rounded-t-3xl shrink-0">
                <h3 class="font-bold text-lg" id="userModalTitle">Perfil de Personal</h3>
                <button onclick="closeModal()" class="hover:text-red-300 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll">
                <form id="userForm">
                    <input type="hidden" id="editUid">
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input id="formDni" placeholder="DNI" class="border p-2.5 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-brand-cyan transition-all">
                        <input id="formName" placeholder="Nombre Completo" class="border p-2.5 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-brand-cyan transition-all">
                        <input id="formUser" placeholder="Usuario" class="border p-2.5 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-brand-cyan transition-all">
                        <input id="formPass" type="password" placeholder="Contrase√±a" class="border p-2.5 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-brand-cyan transition-all">
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <select id="formDept" onchange="updateRoles()" class="border p-2.5 rounded-xl bg-white outline-none focus:border-brand-cyan transition-all">
                            <option disabled selected value="">Departamento...</option>
                            <option value="farmacia">Farmacia</option>
                            <option value="contact_center">Contact Center</option>
                            <option value="operaciones">Operaciones</option>
                            <option value="calidad">Calidad</option>
                            <option value="logistica">Log√≠stica</option>
                            <option value="repartidor">Delivery</option>
                            <option value="admin">Administrador</option>
                        </select>
                        <select id="formJob" multiple class="border p-2.5 rounded-xl h-32 bg-white text-xs custom-scroll outline-none focus:border-brand-cyan"></select>
                    </div>
                    <!-- RESTRICCIONES SEGURIDAD -->
                    <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                        <h4 class="text-xs font-bold text-brand-dark uppercase mb-4 flex items-center"><i class="fa-solid fa-shield-halved mr-2"></i> Seguridad</h4>
                        <div class="flex items-center justify-between mb-4 bg-white p-3 rounded-xl border border-blue-100 shadow-sm">
                             <div class="text-sm font-semibold text-slate-700">Validar IP Nueva</div>
                             <label class="relative inline-flex items-center cursor-pointer">
                                 <input type="checkbox" id="formIpCheck" class="sr-only peer">
                                 <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-clinical transition-all"></div>
                             </label>
                        </div>
                        <input id="formIpKey" class="w-full border p-3 rounded-xl text-xs mb-4 outline-none focus:border-brand-cyan font-mono shadow-sm bg-white" placeholder="LLAVE DE DESBLOQUEO IP">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Lunes"> L</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Martes"> M</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Miercoles"> X</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Jueves"> J</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Viernes"> V</label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="time" id="formStart" class="w-full border p-2 rounded-xl text-sm bg-white outline-none">
                            <input type="time" id="formEnd" class="w-full border p-2 rounded-xl text-sm bg-white outline-none">
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3 rounded-b-3xl bg-slate-50">
                <button onclick="closeModal()" class="px-5 py-2 text-sm font-bold text-slate-500 hover:text-slate-700">Cancelar</button>
                <button onclick="saveUser()" id="btnSave" class="bg-brand-clinical text-white px-8 py-2.5 rounded-xl font-bold shadow-lg transform active:scale-95 transition-all">Guardar Datos</button>
            </div>
        </div>
    </div>

    <!-- MODAL: DERECHOHABIENTE -->
    <div id="benModal" class="fixed inset-0 modal-backdrop hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-4xl flex flex-col max-h-[90vh] shadow-2xl">
            <div class="bg-brand-dark p-6 text-white flex justify-between items-center rounded-t-3xl shrink-0">
                <h3 class="font-bold text-lg" id="benModalTitle">Expediente del Paciente</h3>
                <button onclick="document.getElementById('benModal').classList.add('hidden')" class="hover:text-red-300 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll">
                <form id="benForm" class="space-y-6">
                    <div class="grid grid-cols-2 gap-5">
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">C√©dula</label><input id="benId" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:border-brand-cyan"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Nombre</label><input id="benName" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:border-brand-cyan"></div>
                    </div>
                    <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 grid grid-cols-2 gap-5">
                        <div><label class="text-[10px] font-bold text-blue-700 uppercase ml-1">Pr√≥ximo Env√≠o</label><input type="date" id="benNextShipment" class="w-full border border-blue-200 p-2 rounded-xl text-sm bg-white outline-none"></div>
                        <div class="flex items-center pt-4">
                             <input type="checkbox" id="benPickup" class="w-6 h-6 text-orange-600 rounded-lg border-gray-300 mr-3 cursor-pointer" onchange="toggleCCAssign()">
                             <label for="benPickup" class="text-sm font-bold text-slate-700 cursor-pointer uppercase">Ventanilla</label>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-5">
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Gestor Farmacia</label><select id="benAssignPharma" class="w-full border p-2.5 rounded-xl bg-white outline-none"></select></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Agente CC</label><select id="benAssignCC" class="w-full border p-2.5 rounded-xl bg-white outline-none"></select></div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t bg-slate-50 flex justify-end rounded-b-3xl gap-3">
                <button onclick="document.getElementById('benModal').classList.add('hidden')" class="px-5 py-2 text-sm font-bold text-slate-500">Cancelar</button>
                <button onclick="saveBeneficiary()" id="btnSaveBen" class="bg-brand-dark text-white px-8 py-2.5 rounded-xl font-bold shadow-lg transition-transform active:scale-95">Guardar</button>
            </div>
        </div>
    </div>

    <!-- MODAL: VISOR DE D√çA -->
    <div id="dayModal" class="fixed inset-0 modal-backdrop hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-4xl flex flex-col max-h-[90vh] shadow-2xl overflow-hidden">
            <div class="bg-white border-b p-5 flex justify-between items-center shrink-0">
                <div class="flex items-center gap-4">
                    <h3 class="font-bold text-lg text-brand-dark flex items-center"><i class="fa-regular fa-calendar-check mr-2 text-brand-cyan"></i> Env√≠os <span id="dayModalDate" class="ml-1 text-slate-600 font-normal"></span></h3>
                    <button onclick="downloadDayReport()" class="bg-green-100 text-green-700 text-[10px] font-bold px-3 py-1.5 rounded-lg hover:bg-green-200 transition"><i class="fa-solid fa-file-csv mr-1"></i> EXPORTAR CSV</button>
                </div>
                <button onclick="document.getElementById('dayModal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="flex border-b border-slate-100 shrink-0">
                <button onclick="switchDayTab('route')" id="tab-route" class="w-1/2 py-3 text-xs font-bold tab-btn active uppercase tracking-wider">üöö Domicilio</button>
                <button onclick="switchDayTab('pickup')" id="tab-pickup" class="w-1/2 py-3 text-xs font-bold tab-btn uppercase tracking-wider">üè¢ Ventanilla</button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll bg-slate-50/30 flex-1">
                <div id="content-route" class="space-y-4"></div>
                <div id="content-pickup" class="space-y-4 hidden"></div>
            </div>
        </div>
    </div>

    <!-- MODAL HISTORIAL -->
    <div id="historyModal" class="fixed inset-0 modal-backdrop hidden z-[120] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-3xl flex flex-col shadow-2xl max-h-[85vh] overflow-hidden">
            <div class="bg-brand-dark p-5 text-white flex justify-between shrink-0 font-bold">
                <h3>Historial de Env√≠os</h3>
                <button onclick="document.getElementById('historyModal').classList.add('hidden')"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px]">
                        <tr><th class="p-3">Fecha</th><th class="p-3">Gu√≠a</th><th class="p-3">Estado</th><th class="p-3 text-right">Etapa</th></tr>
                    </thead>
                    <tbody id="hist-list" class="divide-y divide-slate-100"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- SCRIPTS CORE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, onSnapshot, updateDoc, deleteDoc, query, where, getDocs, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC2HWoYjIltPqkysduZ-954-f-kZCFaNdA", authDomain: "fdihss.firebaseapp.com", projectId: "fdihss", storageBucket: "fdihss.firebasestorage.app", messagingSenderId: "1004594046776", appId: "1:1004594046776:web:164dcdb2b023b8719283cd" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "fdihss-mediflow-v2-modular";
        const DOMAIN_SUFFIX = "@mediflow.sys"; 
        
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        let deviceId = localStorage.getItem('mediflow_device_id') || (()=>{ const id=crypto.randomUUID(); localStorage.setItem('mediflow_device_id',id); return id; })();

        window.isPreviewMode = false;
        window.isCreatingUser = false;
        let currentYear = null, currentMonth = null, selectedDate = null;
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        /* --- DECLARACI√ìN DE FUNCIONES DE RENDERIZADO --- */

        window.renderUserRow = function(u, docId) {
             const jobs = Array.isArray(u.jobTitle) ? u.jobTitle : [u.jobTitle || 'General'];
             const jobsDisplay = jobs.map(j => `<span class="bg-slate-100 px-2 py-0.5 rounded text-[10px] mr-1 border border-slate-200">${j}</span>`).join('');
             return `
                <tr class="hover:bg-blue-50/40 border-b border-slate-50 transition group">
                    <td class="p-5 pl-6"><div class="flex items-center"><div class="w-10 h-10 rounded-xl bg-white border border-slate-100 shadow-sm flex items-center justify-center text-sm font-bold text-brand-dark mr-3 uppercase shrink-0">${u.name.charAt(0)}</div><div><div class="font-bold text-slate-700 text-sm">${u.name}</div><div class="text-[11px] text-slate-400 font-mono">${u.dni||'--'}</div></div></div></td>
                    <td class="p-5"><div class="flex flex-col gap-1"><span class="bg-blue-50 text-blue-700 border border-blue-100 px-2 py-0.5 rounded text-[10px] font-bold uppercase w-fit">${u.role.replace('_',' ')}</span><div class="flex flex-wrap gap-1 mt-1">${jobsDisplay}</div></div></td>
                    <td class="p-5"><span class="text-xs font-mono text-slate-500 bg-slate-100 px-2 py-1 rounded border border-slate-200">${u.username}</span></td>
                    <td class="p-5 text-center"><span class="text-[10px] font-bold ${u.status==='online'?'text-emerald-500':'text-slate-400'}">${u.status==='online'?'ONLINE':'OFFLINE'}</span></td>
                    <td class="p-5 pr-6 text-right"><div class="flex justify-end gap-2 opacity-80 hover:opacity-100 transition-opacity"><button onclick="openUserModal(true, '${encodeURIComponent(JSON.stringify({...u, docId}))}')" class="w-8 h-8 rounded-lg bg-blue-50 text-blue-600 hover:bg-blue-600 hover:text-white transition flex items-center justify-center border border-blue-100 shadow-sm" title="Editar"><i class="fa-solid fa-pen"></i></button><button onclick="deleteUser('${docId}', '${u.uid}', '${u.name}', '${u.role}')" class="w-8 h-8 rounded-lg bg-red-50 text-red-600 hover:bg-red-600 hover:text-white transition flex items-center justify-center border border-red-100 shadow-sm" title="Baja"><i class="fa-solid fa-user-slash"></i></button></div></td>
                </tr>`;
        };

        window.renderTimelineItem = function(ship) {
            const statusMap = { 'Nuevo': 1, 'Confirmacion CC': 2, 'Retorno Farmacia': 3, 'Empaquetado': 4, 'Revision Calidad': 5, 'Listo Logistica': 6, 'En Ruta': 7, 'Entregado': 8 };
            let step = statusMap[ship.status] || 1;
            const stepsHtml = [ {l:'FARM', i:1}, {l:'CC', i:2}, {l:'FARM', i:3}, {l:'OPER', i:4}, {l:'CALI', i:5}, {l:'LOGI', i:6}, {l:'RUTA', i:7}, {l:'ENTR', i:8} ].map(s => { 
                const active = s.i <= step ? 'timeline-active' : ''; 
                return `<div class="flex-1 flex flex-col items-center timeline-step ${active}"><div class="w-5 h-5 rounded-full border-2 border-slate-200 bg-white flex items-center justify-center text-[7px] font-bold transition-colors step-dot z-10">${s.i}</div><span class="text-[6px] mt-1 font-bold text-slate-400 uppercase">${s.l}</span></div>`; 
            }).join('');
            return `<div class="bg-white p-4 rounded-2xl border shadow-sm"><div class="flex justify-between items-start mb-3"><div><h4 class="font-bold text-brand-dark">${ship.beneficiaryName}</h4><span class="text-[10px] text-slate-400 font-mono">ID: ${ship.beneficiaryId} | ${ship.guideNumber || 'PENDIENTE'}</span></div><span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-[9px] font-bold uppercase">${ship.status}</span></div><div class="flex relative">${stepsHtml}</div></div>`;
        };

        /* --- FUNCIONES DE NAVEGACI√ìN --- */

        function safeNavigate(targetUrl) {
            try { window.location.href = targetUrl; } catch (e) {
                if (targetUrl === 'index.html') {
                    document.body.innerHTML = `<div style="height:100vh; display:flex; flex-direction:column; align-items:center; justify-content:center; font-family:sans-serif; background:#003366; color:white; text-align:center;"><h2 style="margin-bottom:20px;">Sesi√≥n Finalizada</h2><a href="./index.html" style="background:#06b6d4; color:white; padding:12px 30px; border-radius:8px; text-decoration:none; font-weight:bold;">VOLVER AL LOGIN</a></div>`;
                }
            }
        }

        window.switchView = function(viewId) {
            ['users','beneficiaries','dashboard','shipments','reports'].forEach(id => {
                const el = document.getElementById(`view-${id}`);
                const btn = document.getElementById(`btn-view-${id}`);
                if(el) el.classList.add('hidden-view');
                if(btn) btn.classList.replace('text-white','text-slate-300');
            });
            document.getElementById(`view-${viewId}`).classList.remove('hidden-view');
            document.getElementById(`btn-view-${viewId}`).classList.replace('text-slate-300','text-white');
        };

        window.forceNavigateLogin = () => safeNavigate('index.html');
        window.logout = async () => { if(confirm("¬øCerrar sesi√≥n?")) signOut(auth).then(()=>safeNavigate('index.html')); };

        /* --- BLOQUE: SEGURIDAD (WATCHDOG) --- */
        let inactivityTimer;
        const TIMEOUT_LIMIT = 30 * 60 * 1000; 
        const resetInactivityTimer = () => {
            clearTimeout(inactivityTimer);
            if(auth.currentUser && document.getElementById('auth-lock').classList.contains('hidden')) {
               inactivityTimer = setTimeout(() => { signOut(auth); }, TIMEOUT_LIMIT);
            }
        };
        const checkSession = (u) => {
             onSnapshot(doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'data'), (snap) => {
                 if(snap.exists()) {
                     const data = snap.data();
                     if (data.activeSessionId && data.activeSessionId !== deviceId) {
                         showLockScreen("Sesi√≥n iniciada en otro dispositivo.");
                         signOut(auth); return;
                     }
                     if (data.role !== 'admin') showLockScreen("Acceso Denegado.");
                     else document.getElementById('auth-lock').classList.add('hidden');
                 }
             });
        };
        ['mousemove', 'keydown', 'click', 'scroll', 'touchstart'].forEach(evt => window.addEventListener(evt, resetInactivityTimer));

        /* --- BLOQUE: GESTI√ìN DE PERSONAL --- */
        const roleDefinitions = {
            'farmacia': [{val:'Revisi√≥n y Asignaci√≥n',label:'Revisi√≥n y Asignaci√≥n'},{val:'Despacho de Medicamentos',label:'Despacho'},{val:'Gesti√≥n de Inventario',label:'Inventario'},{val:'Supervisor de Farmacia',label:'Supervisor'}],
            'contact_center': [{val:'Agente Contact Center',label:'Agente Normal'},{val:'Supervisor CC',label:'Supervisor'}],
            'operaciones': [{val:'Operador',label:'Operador Empaque'},{val:'Supervisor Operaciones',label:'Supervisor'}],
            'calidad': [{val:'Revisor de Paquetes',label:'Revisor'},{val:'Controlador Observaciones',label:'Controlador'},{val:'Supervisor Calidad',label:'Supervisor'}],
            'logistica': [{val:'Asignador de Rutas',label:'Asignador Rutas'},{val:'Despachador Delivery',label:'Despachador'},{val:'Supervisor Log√≠stica',label:'Supervisor'}],
            'repartidor': [{val:'Motorista',label:'Motorista'},{val:'Supervisor de Flota',label:'Supervisor'}],
            'admin': [{val:'Super Admin',label:'Administrador'}]
        };

        window.updateRoles = function(selectedJobs = []) {
            const dept = document.getElementById('formDept').value;
            const select = document.getElementById('formJob');
            select.innerHTML = '';
            if (dept && roleDefinitions[dept]) {
                select.disabled = false;
                roleDefinitions[dept].forEach(role => {
                    const opt = document.createElement('option');
                    opt.value = role.val; opt.innerText = role.label;
                    if(selectedJobs.includes(role.val)) opt.selected = true;
                    select.appendChild(opt);
                });
            } else { select.disabled = true; }
        };

        window.openUserModal = function(isEdit = false, encodedData = null) {
            document.getElementById('userForm').reset();
            const userData = encodedData ? JSON.parse(decodeURIComponent(encodedData)) : null;
            document.getElementById('userModalTitle').innerText = isEdit ? "Editar Personal" : "Nuevo Ingreso";
            if(isEdit && userData) {
                document.getElementById('editUid').value = userData.uid;
                document.getElementById('formDni').value = userData.dni || '';
                document.getElementById('formName').value = userData.name;
                document.getElementById('formUser').value = userData.username; document.getElementById('formUser').disabled = true;
                document.getElementById('formDept').value = userData.role;
                window.updateRoles(userData.jobTitle || []);
                document.getElementById('formIpCheck').checked = userData.requireIpApproval || false;
                document.getElementById('formIpKey').value = userData.ipUnlockKey || '';
                document.getElementById('formStart').value = userData.shiftStart || '';
                document.getElementById('formEnd').value = userData.shiftEnd || '';
            } else {
                document.getElementById('editUid').value = ""; document.getElementById('formUser').disabled = false;
                window.updateRoles();
            }
            document.getElementById('userModal').classList.remove('hidden');
        };

        window.closeModal = () => document.getElementById('userModal').classList.add('hidden');

        window.saveUser = async () => {
            const btn = document.getElementById('btnSave');
            const uid = document.getElementById('editUid').value;
            const user = document.getElementById('formUser').value.trim().toLowerCase();
            const dept = document.getElementById('formDept').value;
            const jobs = Array.from(document.getElementById('formJob').selectedOptions).map(o => o.value);
            if(!user || !dept || jobs.length === 0) return alert("Faltan datos.");
            btn.disabled = true; btn.innerText = "...";
            try {
                const userData = { dni: document.getElementById('formDni').value, name: document.getElementById('formName').value, username: user, role: dept, jobTitle: jobs, requireIpApproval: document.getElementById('formIpCheck').checked, ipUnlockKey: document.getElementById('formIpKey').value, shiftStart: document.getElementById('formStart').value, shiftEnd: document.getElementById('formEnd').value, allowedDays: Array.from(document.querySelectorAll('.day-check:checked')).map(c => c.value), lastUpdate: new Date().toISOString() };
                if(uid) {
                    await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data'), userData);
                    const qDir = query(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), where('uid', '==', uid));
                    const snapDir = await getDocs(qDir); snapDir.forEach(d => updateDoc(d.ref, userData));
                } else {
                    window.isCreatingUser = true;
                    const cred = await createUserWithEmailAndPassword(secondaryAuth, user + DOMAIN_SUFFIX, document.getElementById('formPass').value);
                    await signOut(secondaryAuth);
                    userData.uid = cred.user.uid; userData.status = 'offline';
                    await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile', 'data'), userData);
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), userData);
                }
                alert("Guardado."); window.closeModal();
            } catch(e) { alert("Error: " + e.message); } finally { btn.disabled = false; btn.innerText = "Guardar"; window.isCreatingUser = false; }
        };

        /* --- BLOQUE: GESTI√ìN DERECHOHABIENTES Y CSV (ACTUALIZADO AL 100%) --- */

        window.handleCSVUpload = async (input) => {
            const file = input.files[0];
            if(!file) return;

            const statusLabel = document.getElementById('csvStatus');
            statusLabel.classList.remove('hidden');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    const data = results.data;
                    const batch = writeBatch(db);
                    let processed = 0;

                    for (const row of data) {
                        const id = row.ID || row.Id || row.C√©dula;
                        const name = row.Nombre || row.Paciente;
                        if (!id || !name) continue;

                        const benRef = doc(db, 'artifacts', appId, 'public', 'data', 'beneficiaries', id.toString());
                        const benData = {
                            id: id.toString(),
                            name: name,
                            pickupCounter: (row.Ventanilla === 'S' || row.Ventanilla === 'Si' || row.Ventanilla === '1'),
                            nextShipment: row.FechaEnvio || null,
                            lastDispense: row.UltimaDispensacion || null,
                            assignedPharma: { uid: row.FarmaciaUID || "", name: row.FarmaciaNombre || "Sin asignar" },
                            assignedCC: { uid: row.CCUID || "", name: row.CCNombre || "Sin asignar" },
                            updatedAt: new Date().toISOString(),
                            status: 'Activo'
                        };

                        batch.set(benRef, benData, { merge: true });

                        // Sincronizar Calendario si hay fecha
                        if(benData.nextShipment) {
                            const shipId = `${id}_${benData.nextShipment}`;
                            const shipRef = doc(db, 'artifacts', appId, 'public', 'data', 'shipments', shipId);
                            batch.set(shipRef, {
                                date: benData.nextShipment,
                                beneficiaryId: id.toString(),
                                beneficiaryName: name,
                                status: 'Nuevo',
                                pickupCounter: benData.pickupCounter,
                                assignedPharma: benData.assignedPharma,
                                assignedCC: benData.assignedCC,
                                guideNumber: 'PENDIENTE',
                                createdAt: new Date().toISOString()
                            });
                        }
                        processed++;
                    }

                    try {
                        await batch.commit();
                        alert(`‚úÖ Carga completada: ${processed} pacientes sincronizados.`);
                    } catch(e) {
                        alert("Error en la sincronizaci√≥n masiva: " + e.message);
                    } finally {
                        statusLabel.classList.add('hidden');
                        input.value = '';
                    }
                },
                error: (err) => {
                    alert("Error leyendo CSV: " + err.message);
                    statusLabel.classList.add('hidden');
                }
            });
        };

        window.openBeneficiaryModal = (isEdit = false, benData = null) => {
            document.getElementById('benForm').reset();
            if(isEdit && benData) {
                document.getElementById('benId').value = benData.id; document.getElementById('benId').disabled = true;
                document.getElementById('benName').value = benData.name;
                document.getElementById('benPickup').checked = benData.pickupCounter || false;
                document.getElementById('benNextShipment').value = benData.nextShipment || '';
                window.toggleCCAssign(); loadAssignableLists(benData.assignedPharma?.uid, benData.assignedCC?.uid);
            } else { document.getElementById('benId').disabled = false; window.toggleCCAssign(); loadAssignableLists(); }
            document.getElementById('benModal').classList.remove('hidden');
        };

        window.saveBeneficiary = async () => {
            const id = document.getElementById('benId').value;
            const nextDate = document.getElementById('benNextShipment').value;
            const isPickup = document.getElementById('benPickup').checked;
            const name = document.getElementById('benName').value;
            if(!id || !name) return alert("Faltan datos.");
            const valP = document.getElementById('benAssignPharma').value;
            const valC = document.getElementById('benAssignCC').value;
            let ph = { uid: "", name: "Sin asignar" };
            let cc = { uid: "", name: "Sin asignar" };
            if(valP) { const [u,n]=valP.split("|"); ph={uid:u, name:n}; }
            if(!isPickup && valC) { const [u,n]=valC.split("|"); cc={uid:u, name:n}; }
            else if(isPickup) cc={uid:"ventanilla", name:"VENTANILLA"};
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'beneficiaries', id), { id, name, pickupCounter: isPickup, assignedPharma: ph, assignedCC: cc, nextShipment: nextDate, updatedAt: new Date().toISOString() }, {merge:true});
                if(nextDate) {
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shipments', `${id}_${nextDate}`), { date: nextDate, beneficiaryId: id, beneficiaryName: name, status: 'Nuevo', assignedPharma: ph, assignedCC: cc, pickupCounter: isPickup, createdAt: new Date().toISOString() });
                }
                alert("Guardado."); document.getElementById('benModal').classList.add('hidden');
            } catch(e) { alert("Error."); }
        };

        /* --- BLOQUE: LOG√çSTICA --- */
        window.openYear = function(y) { 
            currentYear = y; document.getElementById('ship-years').classList.add('hidden'); 
            document.getElementById('ship-months').classList.remove('hidden'); 
            const c = document.getElementById('ship-months'); c.innerHTML = '';
            monthNames.forEach((m, i) => { c.innerHTML += `<div onclick="openMonth(${i})" class="bg-white p-6 rounded-2xl shadow-sm border hover:border-brand-cyan cursor-pointer text-center font-bold text-slate-700 transition-all">${m}</div>`; }); 
        };
        window.openMonth = function(m) { 
            currentMonth = m; document.getElementById('ship-months').classList.add('hidden'); 
            document.getElementById('ship-days').classList.remove('hidden'); 
            window.renderCalendar(currentYear, currentMonth); 
            window.updateBreadcrumb();
        };
        window.renderCalendar = function(y, m) { 
            const g = document.getElementById('calendar-grid'); g.innerHTML = '';
            const dim = new Date(y, m + 1, 0).getDate();
            const fd = new Date(y, m, 1).getDay();
            for(let i = 0; i < fd; i++) g.innerHTML += `<div></div>`;
            for(let d = 1; d <= dim; d++) {
                const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`;
                g.innerHTML += `<div onclick="openDayView('${ds}')" class="calendar-day bg-white p-2 relative cursor-pointer hover:shadow-md transition-all"><span class="text-sm font-bold">${d}</span><div id="ship-count-${ds}" class="mt-1"></div></div>`;
                window.loadDayStats(ds);
            }
        };
        window.loadDayStats = async function(ds) { 
            const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'shipments'), where('date', '==', ds));
            const s = await getDocs(q);
            if(!s.empty) {
                const el = document.getElementById(`ship-count-${ds}`);
                if(el) el.innerHTML = `<span class="text-[9px] bg-emerald-100 text-emerald-700 px-1.5 rounded font-bold">${s.size} Env√≠os</span>`;
            }
        };

        /* --- STARTUP & LISTENERS --- */
        onAuthStateChanged(auth, async (u) => { if(u){ checkSession(u); resetInactivityTimer(); } else showLockScreen("Inicie sesi√≥n."); });
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), (s) => {
            const l = document.getElementById('user-list'); if(l){ l.innerHTML = ''; s.forEach(d => l.innerHTML += window.renderUserRow(d.data(), d.id)); }
        });
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'beneficiaries'), (s) => {
            const l = document.getElementById('ben-list'); if(l){ l.innerHTML = ''; s.forEach(d => { const b=d.data(); l.innerHTML += `<tr class="hover:bg-slate-50 border-b"><td class="p-4 pl-6 font-bold">${b.name}<br><span class="text-[10px] text-slate-400 font-mono">${b.id}</span></td><td class="p-4 text-xs font-bold ${b.pickupCounter?'text-orange-500':'text-emerald-500'}">${b.pickupCounter?'VENTANILLA':'DOMICILIO'}</td><td class="p-4 text-xs">IHSS</td><td class="p-4 text-[10px] font-bold text-slate-400">P: ${b.assignedPharma?.name||'?'}<br>CC: ${b.assignedCC?.name||'?'}</td><td class="p-4 text-right"><div class="flex justify-end gap-2"><button onclick="openHistory('${b.id}','${b.name}')" class="text-slate-400 hover:text-blue-500"><i class="fa-solid fa-history"></i></button><button onclick="editBeneficiary('${encodeURIComponent(JSON.stringify(b))}')" class="text-blue-600"><i class="fa-solid fa-pen"></i></button></div></td></tr>`; }); }
        });

        /* --- UTILIDADES ADICIONALES --- */
        window.switchDayTab = (t) => {
            const br=document.getElementById('tab-route'), bp=document.getElementById('tab-pickup'), cr=document.getElementById('content-route'), cp=document.getElementById('content-pickup');
            if(t==='route'){ br.classList.add('active'); bp.classList.remove('active'); cr.classList.remove('hidden'); cp.classList.add('hidden'); }
            else { bp.classList.add('active'); br.classList.remove('active'); cp.classList.remove('hidden'); cr.classList.add('hidden'); }
        };
        window.toggleCCAssign = () => { document.getElementById('benAssignCC').disabled = document.getElementById('benPickup').checked; };
        window.resetShipView = () => { currentYear = null; currentMonth = null; document.getElementById('ship-days').classList.add('hidden'); document.getElementById('ship-months').classList.add('hidden'); document.getElementById('ship-years').classList.remove('hidden'); };
        window.updateBreadcrumb = () => { const b = document.getElementById('ship-breadcrumb'); if(!b) return; let h = `<span class="cursor-pointer hover:underline" onclick="resetShipView()">Inicio</span>`; if (currentYear) h += ` > <span class="cursor-pointer hover:underline" onclick="openYear(${currentYear})">${currentYear}</span>`; if (currentMonth !== null) h += ` > <span>${monthNames[currentMonth]}</span>`; b.innerHTML = h; };
        async function loadAssignableLists(phU, ccU){
            const phS = document.getElementById('benAssignPharma'), ccS = document.getElementById('benAssignCC');
            phS.innerHTML = '<option value="">Farmacia...</option>'; ccS.innerHTML = '<option value="">CC...</option>';
            const q = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'));
            q.forEach(d => {
                const u = d.data(); const opt = `<option value="${u.uid}|${u.name}" ${u.uid==phU||u.uid==ccU?'selected':''}>${u.name}</option>`;
                if(u.role === 'farmacia') phS.innerHTML += opt;
                if(u.role === 'contact_center') ccS.innerHTML += opt;
            });
        }
        function showLockScreen(m) { const lock = document.getElementById('auth-lock'); if(lock) { document.getElementById('lock-msg').innerText = m; lock.classList.remove('hidden'); } }

        window.switchView('dashboard');
    </script>
</body>
</html>

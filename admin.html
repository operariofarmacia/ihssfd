<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - IHSS a tu Casa</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse para CSV -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        brand: {
                            dark: '#003366', teal: '#0e7490', cyan: '#06b6d4', clinical: '#10b981', danger: '#ef4444', light: '#f8fafc'
                        }
                    }
                }
            }
        }
    </script>

    <style>
        body { font-family: 'Poppins', sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        .modal-backdrop { background-color: rgba(15, 23, 42, 0.6); backdrop-filter: blur(4px); }
        .toggle-checkbox:checked { right: 0; border-color: #10b981; }
        .toggle-checkbox:checked + .toggle-label { background-color: #10b981; }
        .job-check { accent-color: #06b6d4; width: 16px; height: 16px; cursor: pointer; }
        select { -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .hidden-view { display: none !important; }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px -5px rgba(0, 0, 0, 0.1); }
        .calendar-day { min-height: 110px; transition: all 0.2s; border-radius: 12px; border: 1px solid #e2e8f0; position: relative; }
        .calendar-day:hover { background-color: #f0f9ff; border-color: #06b6d4; }
        .timeline-step { position: relative; z-index: 1; min-width: 50px; }
        .timeline-step::before { content: ''; position: absolute; top: 9px; left: -50%; width: 100%; height: 2px; background: #e2e8f0; z-index: -1; }
        .timeline-step:first-child::before { display: none; }
        .timeline-active .step-dot { background-color: #10b981; color: white; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2); }
        .timeline-active::before { background: #10b981; }
        .tab-btn.active { border-bottom: 3px solid #003366; color: #003366; font-weight: 700; background-color: #f1f5f9; }
        .tab-btn { color: #64748b; transition: all 0.2s; }
    </style>
</head>
<body class="flex flex-col md:flex-row h-screen overflow-hidden text-slate-700 bg-slate-50">

    <!-- BLOQUE: PANTALLA DE BLOQUEO -->
    <div id="auth-lock" class="fixed inset-0 z-[200] bg-[#003366] flex flex-col items-center justify-center text-white hidden fade-in">
        <div class="bg-white p-3 rounded-full mb-5 shadow-2xl ring-4 ring-white/10">
            <img src="https://portal.ihss.hn/cronicos/assets/dist/img/Recurso%201.png" class="h-20 w-20 object-contain">
        </div>
        <h2 class="text-3xl font-bold mb-2 tracking-tight">Sesi贸n Finalizada</h2>
        <p class="text-blue-200 text-sm mb-8 max-w-xs text-center leading-relaxed" id="lock-msg">Tu sesi贸n ha expirado.</p>
        <button onclick="forceNavigateLogin()" class="bg-brand-cyan hover:bg-brand-teal text-white px-8 py-3 rounded-xl font-bold transition-all shadow-lg transform hover:scale-105 flex items-center mb-4">
            <i class="fa-solid fa-arrow-left mr-3"></i> Ir al Login
        </button>
    </div>

    <!-- BLOQUE: SIDEBAR -->
    <aside class="w-full md:w-72 bg-brand-dark text-white flex flex-col shadow-2xl z-20 shrink-0 relative">
        <div class="p-6 border-b border-blue-900/50 flex flex-col items-center text-center">
            <div class="bg-white p-1 rounded-full shadow-lg mb-3 w-16 h-16 flex items-center justify-center ring-2 ring-brand-cyan/50 cursor-pointer hover:scale-105 transition-transform" onclick="switchView('dashboard')">
                <img src="https://portal.ihss.hn/cronicos/assets/dist/img/Recurso%201.png" class="object-contain h-full w-full p-1">
            </div>
            <h2 class="font-bold text-lg tracking-wide text-white">ADMINISTRACIN</h2>
            <p class="text-[10px] text-brand-cyan uppercase tracking-wider mb-2">Panel de Control</p>
            <div class="flex items-center bg-black/20 px-3 py-1 rounded-full border border-white/10 mt-2">
                <span id="status-dot" class="w-2 h-2 rounded-full bg-brand-clinical animate-pulse mr-2"></span>
                <span id="status-text" class="text-[10px] font-bold text-emerald-300 uppercase">Sistema Online</span>
            </div>
        </div>
        <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scroll">
            <button onclick="switchView('dashboard')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition border-l-4 border-transparent" id="btn-view-dashboard">
                <i class="fa-solid fa-house w-5 text-center"></i><span class="font-medium text-sm">Inicio</span>
            </button>
            <div class="pt-4 pb-2 px-3 text-[10px] text-slate-400 font-bold uppercase tracking-wider">Gesti贸n</div>
            <button onclick="switchView('users')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition border-l-4 border-transparent" id="btn-view-users">
                <i class="fa-solid fa-users-gear w-5 text-center"></i><span class="font-medium text-sm">Personal</span>
            </button>
            <button onclick="switchView('beneficiaries')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition border-l-4 border-transparent" id="btn-view-beneficiaries">
                <i class="fa-solid fa-hospital-user w-5 text-center"></i><span class="font-medium text-sm">Derechohabientes</span>
            </button>
            <div class="pt-4 pb-2 px-3 text-[10px] text-slate-400 font-bold uppercase tracking-wider">Operaciones</div>
            <button onclick="switchView('shipments')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition border-l-4 border-transparent" id="btn-view-shipments">
                <i class="fa-solid fa-truck-fast w-5 text-center"></i><span class="font-medium text-sm">Gesti贸n de Env铆os</span>
            </button>
            <button onclick="switchView('reports')" class="w-full flex items-center space-x-3 p-3 rounded-xl text-slate-300 hover:bg-white/10 hover:text-white transition border-l-4 border-transparent" id="btn-view-reports">
                <i class="fa-solid fa-chart-pie w-5 text-center"></i><span class="font-medium text-sm">Reportes</span>
            </button>
        </nav>
        <div class="p-4 bg-black/20 border-t border-white/5 space-y-2">
            <button onclick="logout()" class="w-full bg-red-500/20 hover:bg-red-600 text-red-100 py-2 rounded-lg text-xs font-bold uppercase transition flex items-center justify-center group">
                <i class="fa-solid fa-power-off mr-2 group-hover:scale-110 transition-transform"></i> Cerrar Sesi贸n
            </button>
        </div>
    </aside>

    <!-- BLOQUE: CONTENIDO PRINCIPAL -->
    <main class="flex-1 overflow-hidden flex flex-col bg-slate-50 relative">
        
        <!-- DASHBOARD -->
        <div id="view-dashboard" class="flex-1 flex flex-col h-full overflow-hidden fade-in">
            <header class="bg-white shadow-sm border-b border-slate-200 p-8 z-10 shrink-0">
                <h1 class="text-3xl font-bold text-brand-dark mb-1">Bienvenido al Sistema</h1>
                <p class="text-slate-500">Seleccione un m贸dulo de gesti贸n para comenzar.</p>
            </header>
            <div class="flex-1 overflow-y-auto p-8 custom-scroll">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                    <div onclick="switchView('users')" class="dash-card bg-white rounded-3xl p-6 border border-slate-100 shadow-sm cursor-pointer group relative overflow-hidden">
                        <div class="relative z-10 text-center"><div class="w-14 h-14 mx-auto rounded-2xl bg-blue-50 text-blue-600 flex items-center justify-center text-3xl mb-6 shadow-sm group-hover:scale-110 transition-transform"><i class="fa-solid fa-users-gear"></i></div><h3 class="font-bold text-slate-700">Personal</h3><p class="text-sm text-slate-500 mb-6">Gesti贸n de Accesos</p><span class="text-blue-600 text-sm font-bold flex items-center group-hover:translate-x-2 transition-transform">Acceder <i class="fa-solid fa-arrow-right ml-2"></i></span></div>
                    </div>
                    <div onclick="switchView('beneficiaries')" class="dash-card bg-white rounded-3xl p-6 border border-slate-100 shadow-sm cursor-pointer group relative overflow-hidden">
                        <div class="relative z-10 text-center"><div class="w-14 h-14 mx-auto rounded-2xl bg-emerald-50 text-emerald-600 flex items-center justify-center text-3xl mb-6 shadow-sm group-hover:scale-110 transition-transform"><i class="fa-solid fa-hospital-user"></i></div><h3 class="font-bold text-slate-700">Pacientes</h3><p class="text-sm text-slate-500 mb-6">Afiliados y Asignaciones</p><span class="text-emerald-600 text-sm font-bold flex items-center group-hover:translate-x-2 transition-transform">Acceder <i class="fa-solid fa-arrow-right ml-2"></i></span></div>
                    </div>
                    <div onclick="switchView('shipments')" class="dash-card bg-white rounded-3xl p-6 border border-slate-100 shadow-sm cursor-pointer group relative overflow-hidden">
                        <div class="relative z-10 text-center"><div class="w-14 h-14 mx-auto rounded-2xl bg-cyan-50 text-brand-cyan flex items-center justify-center text-3xl mb-6 shadow-sm group-hover:scale-110 transition-transform"><i class="fa-solid fa-truck-fast"></i></div><h3 class="font-bold text-slate-700">Env铆os</h3><p class="text-sm text-slate-500 mb-6">Calendario Log铆stico</p><span class="text-brand-cyan text-sm font-bold flex items-center group-hover:translate-x-2 transition-transform">Acceder <i class="fa-solid fa-arrow-right ml-2"></i></span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- USUARIOS -->
        <div id="view-users" class="hidden-view flex-1 flex flex-col h-full overflow-hidden fade-in">
            <header class="bg-white shadow-sm border-b border-slate-200 p-6 flex justify-between items-center z-10 shrink-0">
                <div><h1 class="text-2xl font-bold text-brand-dark">Directorio de Personal</h1></div>
                <button onclick="openUserModal()" class="bg-brand-dark hover:bg-brand-cyan text-white px-6 py-2.5 rounded-xl font-bold shadow-lg transition-all flex items-center text-sm"><i class="fa-solid fa-user-plus mr-2"></i> Nuevo Usuario</button>
            </header>
            <div class="flex-1 overflow-y-auto p-6 md:p-8 custom-scroll">
                <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead class="bg-slate-50 text-[11px] uppercase text-slate-500 font-semibold tracking-wider"><tr><th class="p-5 pl-6">Colaborador</th><th class="p-5">Cargo</th><th class="p-5">Acceso</th><th class="p-5 text-center">Estatus</th><th class="p-5 pr-6 text-right">Acciones</th></tr></thead><tbody id="user-list" class="divide-y divide-slate-100 text-sm text-slate-600"><tr><td colspan="5" class="p-8 text-center text-slate-400"><i class="fa-solid fa-spinner fa-spin mr-2"></i>Cargando...</td></tr></tbody></table></div>
                </div>
            </div>
        </div>

        <!-- DERECHOHABIENTES -->
        <div id="view-beneficiaries" class="hidden-view flex-1 flex flex-col h-full overflow-hidden fade-in">
            <header class="bg-white shadow-sm border-b border-slate-200 p-6 flex justify-between items-center z-10 shrink-0">
                <div><h1 class="text-2xl font-bold text-brand-dark">Derechohabientes</h1></div>
                <div class="flex gap-3">
                    <label class="bg-emerald-600 hover:bg-emerald-500 text-white px-5 py-2.5 rounded-xl font-bold shadow-lg cursor-pointer flex items-center text-sm"><i class="fa-solid fa-file-csv mr-2"></i> Importar CSV<input type="file" id="csvInput" accept=".csv" class="hidden" onchange="handleCSVUpload(this)"></label>
                    <button onclick="openBeneficiaryModal()" class="bg-brand-dark hover:bg-brand-cyan text-white px-5 py-2.5 rounded-xl font-bold shadow-lg flex items-center text-sm"><i class="fa-solid fa-plus mr-2"></i> Crear Manual</button>
                </div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 md:p-8 custom-scroll">
                 <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-hidden">
                    <div class="overflow-x-auto"><table class="w-full text-left border-collapse"><thead class="bg-slate-50 text-[11px] uppercase text-slate-500 font-semibold tracking-wider"><tr><th class="p-5 pl-6">Identidad / Prioridad</th><th class="p-5">Tipo</th><th class="p-5">Ubicaci贸n</th><th class="p-5">Gestores</th><th class="p-5 text-right">Acciones</th></tr></thead><tbody id="ben-list" class="divide-y divide-slate-100 text-sm text-slate-600"></tbody></table></div>
                </div>
            </div>
        </div>

        <!-- ENVOS -->
        <div id="view-shipments" class="hidden-view flex-1 flex flex-col h-full overflow-hidden fade-in">
            <header class="bg-white shadow-sm border-b border-slate-200 p-6 flex justify-between items-center z-10 shrink-0">
                <div><h1 class="text-2xl font-bold text-brand-dark flex items-center"><i class="fa-solid fa-truck-ramp-box mr-3 text-brand-cyan"></i> Gesti贸n de Env铆os</h1><nav class="flex text-xs text-slate-500 mt-1" id="ship-breadcrumb"><span class="font-bold text-brand-dark">Inicio</span></nav></div>
            </header>
            <div class="flex-1 overflow-y-auto p-6 md:p-8 custom-scroll bg-slate-50/50">
                <div id="ship-years" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"><div onclick="openYear(2026)" class="bg-white p-8 rounded-3xl shadow-sm border border-slate-200 hover:border-brand-cyan hover:shadow-xl cursor-pointer transition-all group text-center year-card" data-year="2026"><div class="text-4xl font-bold text-brand-dark group-hover:text-brand-cyan mb-2">2026</div><p class="text-xs text-slate-400 uppercase tracking-widest">A帽o Fiscal</p></div><div onclick="createNewYear()" class="bg-slate-100 p-8 rounded-3xl border-2 border-dashed border-slate-300 hover:border-brand-cyan hover:bg-white cursor-pointer transition-all group text-center flex flex-col items-center justify-center"><div class="w-12 h-12 rounded-full bg-slate-200 text-slate-400 flex items-center justify-center text-xl mb-2 group-hover:bg-brand-cyan group-hover:text-white transition-colors"><i class="fa-solid fa-plus"></i></div><p class="text-xs text-slate-400 font-bold uppercase tracking-widest group-hover:text-brand-cyan">Crear A帽o</p></div></div>
                <div id="ship-months" class="hidden grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6"></div>
                <div id="ship-days" class="hidden"><div class="bg-white rounded-2xl shadow-sm border border-slate-200 p-6"><div class="grid grid-cols-7 gap-2 mb-2 text-center text-xs font-bold text-slate-400 uppercase"><div>Dom</div><div>Lun</div><div>Mar</div><div>Mi茅</div><div>Jue</div><div>Vie</div><div>S谩b</div></div><div id="calendar-grid" class="grid grid-cols-7 gap-2"></div></div></div>
            </div>
        </div>

        <!-- REPORTES -->
        <div id="view-reports" class="hidden-view flex-1 flex flex-col h-full overflow-hidden fade-in items-center justify-center text-center">
            <div class="bg-white p-10 rounded-full shadow-lg mb-6 ring-8 ring-slate-100"><i class="fa-solid fa-chart-pie text-6xl text-slate-300"></i></div>
            <h2 class="text-3xl font-bold text-slate-700 mb-2">M贸dulo de Reportes</h2>
            <p class="text-slate-500 max-w-md">Pr贸ximamente</p>
        </div>
    </main>

    <!-- ========================================== -->
    <!-- BLOQUE 3: MODALES Y FORMULARIOS            -->
    <!-- ========================================== -->

    <!-- MODAL CSV PROGRESS (NUEVO) -->
    <div id="csvProgressModal" class="fixed inset-0 modal-backdrop hidden z-[150] flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm w-full text-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-brand-cyan mx-auto mb-4"></div>
            <h3 class="text-lg font-bold text-slate-700 mb-1">Importando Base de Datos</h3>
            <p class="text-sm text-slate-500 mb-4" id="csvProgressText">Procesando archivo...</p>
            <div class="w-full bg-slate-200 rounded-full h-2.5 dark:bg-slate-300">
                <div class="bg-brand-cyan h-2.5 rounded-full" id="csvProgressBar" style="width: 0%"></div>
            </div>
        </div>
    </div>

    <!-- MODAL USUARIO -->
    <div id="userModal" class="fixed inset-0 modal-backdrop hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-3xl flex flex-col max-h-[90vh] shadow-2xl">
            <div class="bg-brand-dark p-6 text-white flex justify-between items-center rounded-t-3xl shrink-0">
                <h3 class="font-bold text-lg" id="userModalTitle">Gesti贸n de Personal</h3>
                <button onclick="closeModal()" class="hover:text-red-300 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll">
                <form id="userForm">
                    <input type="hidden" id="editUid">
                    <!-- Datos B谩sicos -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <input id="formDni" placeholder="DNI" class="border p-2.5 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-brand-cyan transition-all">
                        <input id="formName" placeholder="Nombre Completo" class="border p-2.5 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-brand-cyan transition-all">
                        <input id="formUser" placeholder="Usuario" class="border p-2.5 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-brand-cyan transition-all">
                        <input id="formPass" type="password" placeholder="Contrase帽a Nueva" class="border p-2.5 rounded-xl bg-slate-50 focus:bg-white outline-none focus:border-brand-cyan transition-all">
                    </div>
                    <!-- Roles -->
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <select id="formDept" onchange="updateRoles()" class="border p-2.5 rounded-xl bg-white outline-none focus:border-brand-cyan transition-all">
                            <option disabled selected value="">Departamento...</option>
                            <option value="farmacia">Farmacia</option>
                            <option value="contact_center">Contact Center</option>
                            <option value="operaciones">Operaciones</option>
                            <option value="calidad">Calidad</option>
                            <option value="logistica">Log铆stica</option>
                            <option value="repartidor">Delivery</option>
                            <option value="admin">Administrador</option>
                        </select>
                        <select id="formJob" multiple class="border p-2.5 rounded-xl h-32 bg-white text-xs custom-scroll outline-none focus:border-brand-cyan"></select>
                    </div>
                    <!-- Seguridad -->
                    <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100">
                        <h4 class="text-xs font-bold text-brand-dark uppercase mb-4 flex items-center"><i class="fa-solid fa-shield-halved mr-2"></i> Seguridad</h4>
                        <div class="flex items-center justify-between mb-4 bg-white p-3 rounded-xl border border-blue-100 shadow-sm">
                             <div class="text-sm font-semibold text-slate-700">Validar IP Nueva</div>
                             <label class="relative inline-flex items-center cursor-pointer">
                                 <input type="checkbox" id="formIpCheck" class="sr-only peer">
                                 <div class="w-11 h-6 bg-slate-200 rounded-full peer peer-checked:after:translate-x-full after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-brand-clinical transition-all"></div>
                             </label>
                        </div>
                        <input id="formIpKey" class="w-full border p-3 rounded-xl text-xs mb-4 outline-none focus:border-brand-cyan font-mono shadow-sm bg-white" placeholder="LLAVE DE DESBLOQUEO IP">
                        <div class="flex flex-wrap gap-2 mb-4">
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Lunes"> L</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Martes"> M</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Miercoles"> X</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Jueves"> J</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-1" value="Viernes"> V</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-2" value="Sabado"> S</label>
                            <label class="text-xs bg-white border px-3 py-1.5 rounded-full cursor-pointer hover:border-brand-cyan transition shadow-sm"><input type="checkbox" class="day-check mr-2" value="Domingo"> D</label>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <input type="time" id="formStart" class="w-full border p-2 rounded-xl text-sm bg-white shadow-sm outline-none">
                            <input type="time" id="formEnd" class="w-full border p-2 rounded-xl text-sm bg-white shadow-sm outline-none">
                        </div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t border-slate-100 flex justify-end gap-3 rounded-b-3xl bg-slate-50">
                <button onclick="closeModal()" class="px-5 py-2 text-sm font-bold text-slate-500 hover:text-slate-700">Cancelar</button>
                <button onclick="saveUser()" id="btnSave" class="bg-brand-clinical text-white px-8 py-2.5 rounded-xl font-bold shadow-lg transform active:scale-95 transition-all">Crear Usuario</button>
            </div>
        </div>
    </div>

    <!-- MODAL BENEFICIARIO (COMPLETO) -->
    <div id="benModal" class="fixed inset-0 modal-backdrop hidden z-[110] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl w-full max-w-4xl flex flex-col max-h-[90vh] shadow-2xl">
            <div class="bg-brand-dark p-6 text-white flex justify-between items-center rounded-t-3xl shrink-0">
                <h3 class="font-bold text-lg" id="benModalTitle">Expediente de Paciente</h3>
                <button onclick="document.getElementById('benModal').classList.add('hidden')" class="hover:text-red-300 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto custom-scroll">
                <form id="benForm" class="space-y-6">
                    <div class="grid grid-cols-2 gap-5">
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">ID (C茅dula)</label><input id="benId" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:border-brand-cyan"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Nombre</label><input id="benName" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:border-brand-cyan"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Tel茅fono</label><input id="benPhone" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:border-brand-cyan"></div>
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Municipio</label><input id="benMuni" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:border-brand-cyan"></div>
                        <div class="col-span-2"><label class="text-xs font-bold text-slate-400 uppercase ml-1">Direcci贸n Exacta</label><input id="benAddr" class="w-full border p-2.5 rounded-xl bg-slate-50 outline-none focus:border-brand-cyan"></div>
                    </div>
                    <div class="bg-blue-50 p-5 rounded-2xl border border-blue-100 grid grid-cols-2 gap-5">
                        <div><label class="text-[10px] font-bold text-blue-700 uppercase ml-1">ltima Dispensaci贸n</label><input type="date" id="benLastDispense" class="w-full border border-blue-200 p-2 rounded-xl text-sm bg-white outline-none" onchange="calculateNextDate()"></div>
                        <div><label class="text-[10px] font-bold text-blue-700 uppercase ml-1">Pr贸ximo Env铆o</label><input type="date" id="benNextShipment" class="w-full border border-blue-200 p-2 rounded-xl text-sm bg-white outline-none"></div>
                    </div>
                    <!-- CONTACTO FAMILIAR -->
                    <div class="bg-slate-50 p-4 rounded-xl border border-slate-100 relative">
                        <h4 class="text-xs font-bold text-slate-400 uppercase mb-3 flex items-center"><i class="fa-solid fa-users mr-2"></i> Contacto Familiar</h4>
                        <div class="grid grid-cols-2 gap-5">
                            <div><label class="text-[10px] font-bold text-slate-400 uppercase">Nombre Familiar</label><input id="benFamName" class="w-full border p-2 rounded-lg bg-white outline-none"></div>
                            <div><label class="text-[10px] font-bold text-slate-400 uppercase">Tel茅fono Familiar</label><input id="benFamPhone" class="w-full border p-2 rounded-lg bg-white outline-none"></div>
                        </div>
                    </div>
                    <div class="flex items-center p-3 bg-orange-50 border border-orange-100 rounded-lg">
                        <input type="checkbox" id="benPickup" class="w-5 h-5 text-orange-600 rounded-lg border-gray-300 mr-3 cursor-pointer" onchange="toggleCCAssign()">
                        <label for="benPickup" class="text-sm font-bold text-slate-700 cursor-pointer uppercase">Entregar en Ventanilla</label>
                    </div>
                    <div class="grid grid-cols-3 gap-5">
                        <div><label class="text-xs font-bold text-slate-400 uppercase ml-1">Tipo Afiliado</label><select id="benType" class="w-full border p-2.5 rounded-xl bg-white outline-none"><option>Afiliado Directo</option><option>Jubilado</option><option>Pensionado</option><option>Beneficiaria Padre</option><option>Beneficiaria(o) Compa帽era(o)</option><option>Beneficiaria(o) Esposa(o)</option><option>Beneficiaria Hijo(a)</option></select></div>
                        <div><label class="text-xs font-bold text-emerald-600 uppercase ml-1">Gestor Farmacia</label><select id="benAssignPharma" class="w-full border p-2.5 rounded-xl bg-white outline-none border-emerald-200 focus:border-emerald-500"></select></div>
                        <div><label class="text-xs font-bold text-blue-600 uppercase ml-1">Gestor CC</label><select id="benAssignCC" class="w-full border p-2.5 rounded-xl bg-white outline-none border-blue-200 focus:border-blue-500"></select></div>
                    </div>
                </form>
            </div>
            <div class="p-6 border-t bg-slate-50 flex justify-end rounded-b-3xl gap-3">
                <button onclick="document.getElementById('benModal').classList.add('hidden')" class="px-5 py-2 text-sm font-bold text-slate-500">Cancelar</button>
                <button onclick="saveBeneficiary()" id="btnSaveBen" class="bg-brand-dark text-white px-8 py-2.5 rounded-xl font-bold shadow-lg transition-transform active:scale-95">Crear Expediente</button>
            </div>
        </div>
    </div>

    <!-- MODALES DE LOGSTICA (IDNTICOS AL ANTERIOR) -->
    <div id="dayModal" class="fixed inset-0 modal-backdrop hidden z-[110] flex items-center justify-center p-4"><div class="bg-white rounded-3xl w-full max-w-4xl flex flex-col max-h-[90vh] shadow-2xl overflow-hidden"><div class="bg-white border-b p-5 flex justify-between items-center shrink-0"><div class="flex items-center gap-4"><h3 class="font-bold text-lg text-brand-dark flex items-center"><i class="fa-regular fa-calendar-check mr-2 text-brand-cyan"></i> Env铆os <span id="dayModalDate" class="ml-1 text-slate-600 font-normal"></span></h3><button onclick="downloadDayReport()" class="bg-green-100 text-green-700 text-[10px] font-bold px-3 py-1.5 rounded-lg hover:bg-green-200 transition"><i class="fa-solid fa-file-csv mr-1"></i> EXPORTAR CSV</button></div><button onclick="document.getElementById('dayModal').classList.add('hidden')" class="text-slate-400 hover:text-red-500 transition-colors"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="flex border-b border-slate-100 shrink-0"><button onclick="switchDayTab('route')" id="tab-route" class="w-1/2 py-3 text-xs font-bold tab-btn active uppercase tracking-wider"> Domicilio</button><button onclick="switchDayTab('pickup')" id="tab-pickup" class="w-1/2 py-3 text-xs font-bold tab-btn uppercase tracking-wider"> Ventanilla</button></div><div class="p-6 overflow-y-auto custom-scroll bg-slate-50/30 flex-1"><div id="content-route" class="space-y-4"></div><div id="content-pickup" class="space-y-4 hidden"></div></div></div></div>
    <div id="historyModal" class="fixed inset-0 modal-backdrop hidden z-[120] flex items-center justify-center p-4"><div class="bg-white rounded-3xl w-full max-w-3xl flex flex-col shadow-2xl max-h-[85vh] overflow-hidden"><div class="bg-brand-dark p-5 text-white flex justify-between shrink-0 font-bold"><h3>Historial de Env铆os</h3><button onclick="document.getElementById('historyModal').classList.add('hidden')"><i class="fa-solid fa-xmark text-xl"></i></button></div><div class="p-6 overflow-y-auto custom-scroll"><table class="w-full text-left text-sm"><thead class="bg-slate-50 text-slate-500 font-bold uppercase text-[10px]"><tr><th class="p-3">Fecha</th><th class="p-3">Gu铆a</th><th class="p-3">Estado</th><th class="p-3 text-right">Etapa</th></tr></thead><tbody id="hist-list" class="divide-y divide-slate-100 text-slate-600"></tbody></table></div></div></div>
    <div id="shipmentModal" class="fixed inset-0 modal-backdrop hidden z-[80] flex items-center justify-center p-4"><div class="bg-white rounded-2xl w-full max-w-xl flex flex-col"><div class="bg-brand-dark p-5 flex justify-between text-white"><h3 class="font-bold">Nueva Gu铆a</h3><button onclick="document.getElementById('shipmentModal').classList.add('hidden')"><i class="fa-solid fa-xmark"></i></button></div><div class="p-6"><form id="shipForm" class="space-y-4"><input type="hidden" id="shipDate"><p id="shipDateDisplay" class="font-bold text-center"></p><select id="shipBeneficiary" class="border w-full p-2 rounded"><option>Cargando...</option></select><input id="shipGuide" placeholder="Tracking #" class="border w-full p-2 rounded"><select id="shipStatus" class="border w-full p-2 rounded"><option>Nuevo</option><option>En Proceso</option><option>Confirmacion CC</option><option>Retorno Farmacia</option><option>Empaquetado</option><option>Revision Calidad</option><option>Listo Logistica</option><option>En Ruta</option><option>Entregado</option></select></form></div><div class="p-5 border-t flex justify-end gap-3"><button onclick="document.getElementById('shipmentModal').classList.add('hidden')" class="text-slate-500">Cancelar</button><button onclick="saveShipment()" class="bg-brand-cyan text-white px-4 py-2 rounded">Guardar</button></div></div></div>

    <!-- SCRIPTS -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getAuth, signOut, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, setDoc, doc, getDoc, onSnapshot, updateDoc, deleteDoc, query, where, getDocs, orderBy, writeBatch } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyC2HWoYjIltPqkysduZ-954-f-kZCFaNdA", authDomain: "fdihss.firebaseapp.com", projectId: "fdihss", storageBucket: "fdihss.firebasestorage.app", messagingSenderId: "1004594046776", appId: "1:1004594046776:web:164dcdb2b023b8719283cd" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "fdihss-mediflow-v2-modular";
        const secondaryApp = initializeApp(firebaseConfig, "Secondary");
        const secondaryAuth = getAuth(secondaryApp);

        let deviceId = localStorage.getItem('mediflow_device_id') || (()=>{ const id=crypto.randomUUID(); localStorage.setItem('mediflow_device_id',id); return id; })();
        let currentYear = null, currentMonth = null, selectedDate = null;
        const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];

        /* --- BLOQUE: RENDERIZADO Y VISTAS --- */
        window.switchView = function(viewId) { ['users','beneficiaries','dashboard','shipments','reports'].forEach(id => { const el = document.getElementById(`view-${id}`); const btn = document.getElementById(`btn-view-${id}`); if(el) el.classList.add('hidden-view'); if(btn) btn.classList.replace('text-white','text-slate-300'); }); document.getElementById(`view-${viewId}`).classList.remove('hidden-view'); document.getElementById(`btn-view-${viewId}`).classList.replace('text-slate-300','text-white'); };
        window.forceNavigateLogin = () => window.location.href = 'index.html';
        window.logout = async () => { if(confirm("驴Cerrar sesi贸n?")) signOut(auth).then(()=>window.location.href='index.html'); };

        /* --- BLOQUE: SEGURIDAD --- */
        const checkSession = (u) => { onSnapshot(doc(db, 'artifacts', appId, 'users', u.uid, 'profile', 'data'), (snap) => { if(snap.exists()) { const data = snap.data(); if (data.requireIpApproval && data.activeSessionId && data.activeSessionId !== deviceId) { document.getElementById('auth-lock').classList.remove('hidden'); signOut(auth); return; } if (data.role !== 'admin') document.getElementById('auth-lock').classList.remove('hidden'); else document.getElementById('auth-lock').classList.add('hidden'); } }); };
        onAuthStateChanged(auth, async (u) => { if(u) checkSession(u); else document.getElementById('auth-lock').classList.remove('hidden'); });

        /* --- BLOQUE: USUARIOS --- */
        const roleDefinitions = { 'farmacia':[{val:'Revisi贸n y Asignaci贸n',label:'Revisi贸n y Asignaci贸n'},{val:'Despacho de Medicamentos',label:'Despacho'},{val:'Gesti贸n de Inventario',label:'Inventario'},{val:'Supervisor de Farmacia',label:'Supervisor'}], 'contact_center':[{val:'Agente Contact Center',label:'Agente Normal'},{val:'Supervisor CC',label:'Supervisor CC'}], 'operaciones':[{val:'Operador',label:'Operador de Empaque'},{val:'Supervisor Operaciones',label:'Supervisor Operaciones'}], 'calidad':[{val:'Revisor de Paquetes',label:'Revisor de Paquetes'},{val:'Controlador Observaciones',label:'Controlador de Observaciones'},{val:'Supervisor Calidad',label:'Supervisor Calidad'}], 'logistica':[{val:'Asignador de Rutas',label:'Asignador de Rutas'},{val:'Despachador Delivery',label:'Despachador Delivery'},{val:'Supervisor Log铆stica',label:'Supervisor Log铆stica'}], 'repartidor':[{val:'Motorista',label:'Motorista'},{val:'Supervisor de Flota',label:'Supervisor de Flota'}], 'admin':[{val:'Super Admin',label:'Administrador Total'}] };
        window.updateRoles = function(selectedJobs = []) { const dept = document.getElementById('formDept').value; const select = document.getElementById('formJob'); select.innerHTML = ''; if (dept && roleDefinitions[dept]) { select.disabled = false; roleDefinitions[dept].forEach(role => { const opt = document.createElement('option'); opt.value = role.val; opt.innerText = role.label; if(selectedJobs.includes(role.val)) opt.selected = true; select.appendChild(opt); }); } else { select.disabled = true; } };
        window.openUserModal = function(isEdit = false, encodedData = null) { document.getElementById('userForm').reset(); const userData = encodedData ? JSON.parse(decodeURIComponent(encodedData)) : null; document.getElementById('userModalTitle').innerText = isEdit ? "Editar Personal" : "Nuevo Ingreso"; document.getElementById('btnSave').innerText = isEdit ? "Actualizar Usuario" : "Crear Usuario"; if(isEdit && userData) { document.getElementById('editUid').value = userData.uid; document.getElementById('formDni').value = userData.dni || ''; document.getElementById('formName').value = userData.name; document.getElementById('formUser').value = userData.username; document.getElementById('formUser').disabled = true; document.getElementById('formDept').value = userData.role; window.updateRoles(userData.jobTitle || []); document.getElementById('formIpCheck').checked = userData.requireIpApproval || false; document.getElementById('formIpKey').value = userData.ipUnlockKey || ''; document.getElementById('formStart').value = userData.shiftStart || ''; document.getElementById('formEnd').value = userData.shiftEnd || ''; document.querySelectorAll('.day-check').forEach(cb => { if(userData.allowedDays?.includes(cb.value)) cb.checked = true; }); } else { document.getElementById('editUid').value = ""; document.getElementById('formUser').disabled = false; window.updateRoles(); } document.getElementById('userModal').classList.remove('hidden'); };
        window.closeModal = () => document.getElementById('userModal').classList.add('hidden');
        window.saveUser = async () => { const btn = document.getElementById('btnSave'); const uid = document.getElementById('editUid').value; const user = document.getElementById('formUser').value.trim().toLowerCase(); const pass = document.getElementById('formPass').value; const dept = document.getElementById('formDept').value; const jobs = Array.from(document.getElementById('formJob').selectedOptions).map(o => o.value); if(!user || !dept || jobs.length === 0) return alert("Faltan datos."); btn.disabled = true; try { const userData = { dni: document.getElementById('formDni').value, name: document.getElementById('formName').value, username: user, role: dept, jobTitle: jobs, requireIpApproval: document.getElementById('formIpCheck').checked, ipUnlockKey: document.getElementById('formIpKey').value, shiftStart: document.getElementById('formStart').value, shiftEnd: document.getElementById('formEnd').value, allowedDays: Array.from(document.querySelectorAll('.day-check:checked')).map(c => c.value), lastUpdate: new Date().toISOString() }; if(uid) { await updateDoc(doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data'), userData); const qDir = query(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), where('uid', '==', uid)); const snapDir = await getDocs(qDir); snapDir.forEach(d => updateDoc(d.ref, userData)); } else { const cred = await createUserWithEmailAndPassword(secondaryAuth, user + DOMAIN_SUFFIX, document.getElementById('formPass').value); await signOut(secondaryAuth); userData.uid = cred.user.uid; userData.status = 'offline'; await setDoc(doc(db, 'artifacts', appId, 'users', cred.user.uid, 'profile', 'data'), userData); await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), userData); } alert("Guardado."); window.closeModal(); } catch(e) { alert("Error: " + e.message); } finally { btn.disabled = false; } };
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory'), (s) => { const l = document.getElementById('user-list'); l.innerHTML = ''; s.forEach(d => { const u = d.data(); const jobs = u.jobTitle.join(', '); l.innerHTML += `<tr><td class="p-4">${u.name}</td><td class="p-4 text-xs">${jobs}</td><td class="p-4">${u.role}</td><td class="p-4 text-center">${u.status}</td><td class="p-4 text-right"><button onclick="openUserModal(true, '${encodeURIComponent(JSON.stringify({...u, uid: u.uid}))}')" class="text-blue-500"><i class="fa-solid fa-pen"></i></button></td></tr>`; }); });

        /* --- BLOQUE: DERECHOHABIENTES Y CSV --- */
        window.calculateNextDate = () => { const last = document.getElementById('benLastDispense').value; if(last) { const date = new Date(last); date.setDate(date.getDate() + 30); document.getElementById('benNextShipment').value = date.toISOString().split('T')[0]; } };
        window.toggleCCAssign = () => { const p = document.getElementById('benPickup').checked; document.getElementById('benAssignCC').disabled = p; };
        async function loadAssignableLists(phU, ccU){ const phS = document.getElementById('benAssignPharma'), ccS = document.getElementById('benAssignCC'); phS.innerHTML = '<option value="">Farmacia...</option>'; ccS.innerHTML = '<option value="">CC...</option>'; const q = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'users_directory')); q.forEach(d => { const u = d.data(); const opt = `<option value="${u.uid}|${u.name}" ${u.uid==phU||u.uid==ccU?'selected':''}>${u.name}</option>`; if(u.role === 'farmacia') phS.innerHTML += opt; if(u.role === 'contact_center') ccS.innerHTML += opt; }); }
        window.openBeneficiaryModal = (isEdit = false, benData = null) => { document.getElementById('benForm').reset(); document.getElementById('benModalTitle').innerText = isEdit ? "Editar Derechohabiente" : "Nuevo Derechohabiente"; document.getElementById('btnSaveBen').innerText = isEdit ? "Actualizar Expediente" : "Crear Expediente"; if(isEdit && benData) { document.getElementById('benId').value = benData.id; document.getElementById('benId').disabled = true; document.getElementById('benName').value = benData.name; document.getElementById('benPhone').value = benData.phone || ''; document.getElementById('benMuni').value = benData.municipality || ''; document.getElementById('benAddr').value = benData.address || ''; document.getElementById('benFamName').value = benData.family?.name || ''; document.getElementById('benFamPhone').value = benData.family?.phone || ''; document.getElementById('benType').value = benData.type || 'Afiliado Directo'; document.getElementById('benLastDispense').value = benData.lastDispense || ''; document.getElementById('benNextShipment').value = benData.nextShipment || ''; document.getElementById('benPickup').checked = benData.pickupCounter || false; window.toggleCCAssign(); loadAssignableLists(benData.assignedPharma?.uid, benData.assignedCC?.uid); } else { document.getElementById('benId').disabled = false; window.toggleCCAssign(); loadAssignableLists(); } document.getElementById('benModal').classList.remove('hidden'); };
        window.editBeneficiary = (s) => window.openBeneficiaryModal(true, JSON.parse(decodeURIComponent(s)));
        window.saveBeneficiary = async () => { const id = document.getElementById('benId').value; const name = document.getElementById('benName').value; const nextDate = document.getElementById('benNextShipment').value; const isPickup = document.getElementById('benPickup').checked; if(!id || !name) return alert("Faltan datos."); const valP = document.getElementById('benAssignPharma').value; const valC = document.getElementById('benAssignCC').value; let ph = { uid: "", name: "Sin asignar" }; let cc = { uid: "", name: "Sin asignar" }; if(valP) { const [u,n]=valP.split("|"); ph={uid:u, name:n}; } if(!isPickup && valC) { const [u,n]=valC.split("|"); cc={uid:u, name:n}; } else if(isPickup) cc={uid:"ventanilla", name:"VENTANILLA"}; try{ await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'beneficiaries', id), { id, name, phone: document.getElementById('benPhone').value, address: document.getElementById('benAddr').value, municipality: document.getElementById('benMuni').value, family: { name: document.getElementById('benFamName').value, phone: document.getElementById('benFamPhone').value }, type: document.getElementById('benType').value, pickupCounter: isPickup, assignedPharma: ph, assignedCC: cc, nextShipment: nextDate, updatedAt: new Date().toISOString() }, {merge:true}); if(nextDate) { await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'shipments', `${id}_${nextDate}`), { date: nextDate, beneficiaryId: id, beneficiaryName: name, status: 'Nuevo', assignedPharma: ph, assignedCC: cc, pickupCounter: isPickup, createdAt: new Date().toISOString() }); } alert("Guardado."); document.getElementById('benModal').classList.add('hidden'); } catch(e) { alert("Error."); } };
        window.handleCSVUpload = async (input) => { 
            const file = input.files[0]; if(!file) return;
            Papa.parse(file, { header: true, skipEmptyLines: true, complete: async (res) => {
                const batch = writeBatch(db); let count = 0;
                res.data.forEach(row => {
                    const id = row.ID || row.C茅dula; const name = row.Nombre; if(!id) return;
                    // L贸gica para no duplicar: setDoc con merge actualiza si existe, crea si no
                    batch.set(doc(db, 'artifacts', appId, 'public', 'data', 'beneficiaries', id), { id, name, updatedAt: new Date().toISOString(), status: 'Activo' }, { merge: true });
                    count++;
                });
                await batch.commit();
                alert(`Procesados ${count} registros.`);
            }});
        };
        onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'beneficiaries'), (s) => { const l = document.getElementById('ben-list'); l.innerHTML = ''; s.forEach(d => { const b=d.data(); l.innerHTML += `<tr class="border-b hover:bg-slate-50"><td class="p-4 pl-6 font-bold">${b.name}<br><span class="text-[10px] text-slate-400">${b.id}</span></td><td class="p-4 text-xs">${b.type}</td><td class="p-4 text-xs">${b.municipality||''}</td><td class="p-4 text-[10px]">P:${b.assignedPharma?.name||'?'} CC:${b.assignedCC?.name||'?'}</td><td class="p-4 text-right"><button onclick="editBeneficiary('${encodeURIComponent(JSON.stringify(b))}')" class="text-blue-500"><i class="fa-solid fa-pen"></i></button></td></tr>`; }); });

        /* --- BLOQUE: LOGSTICA Y ENVOS --- */
        window.openYear = (y) => { currentYear=y; document.getElementById('ship-years').classList.add('hidden'); document.getElementById('ship-months').classList.remove('hidden'); document.getElementById('ship-months').className="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 fade-in"; const c=document.getElementById('ship-months'); c.innerHTML=''; monthNames.forEach((m,i)=>{ c.innerHTML+=`<div onclick="openMonth(${i})" class="bg-white p-6 rounded-2xl shadow-sm border hover:border-brand-cyan cursor-pointer text-center font-bold text-slate-700 transition-all">${m}</div>`; }); window.updateBreadcrumb(); };
        window.openMonth = (m) => { currentMonth=m; document.getElementById('ship-months').classList.add('hidden'); document.getElementById('ship-days').classList.remove('hidden'); window.renderCalendar(currentYear, currentMonth); window.updateBreadcrumb(); };
        window.renderCalendar = (y, m) => { const g = document.getElementById('calendar-grid'); g.innerHTML = ''; const dim = new Date(y, m + 1, 0).getDate(); const fd = new Date(y, m, 1).getDay(); for(let i = 0; i < fd; i++) g.innerHTML += `<div></div>`; for(let d = 1; d <= dim; d++) { const ds = `${y}-${String(m + 1).padStart(2, '0')}-${String(d).padStart(2, '0')}`; g.innerHTML += `<div onclick="openDayView('${ds}')" class="calendar-day bg-white border border-slate-100 rounded-xl p-2 relative cursor-pointer hover:shadow-md"><span class="text-sm font-bold text-slate-700">${d}</span></div>`; } };
        window.openDayView = async (dateStr) => { selectedDate = dateStr; document.getElementById('dayModalDate').innerText = dateStr; document.getElementById('dayModal').classList.remove('hidden'); window.switchDayTab('route'); const q = query(collection(db, 'artifacts', appId, 'public', 'data', 'shipments'), where('date', '==', dateStr)); const snap = await getDocs(q); const lr = document.getElementById('content-route'), lp = document.getElementById('content-pickup'); lr.innerHTML = ''; lp.innerHTML = ''; snap.forEach(d => { const s = d.data(); const h = `<div class="bg-white p-4 border rounded shadow-sm mb-2"><h4 class="font-bold">${s.beneficiaryName}</h4><span class="text-xs text-blue-600 font-bold">${s.status}</span></div>`; if(s.pickupCounter) lp.innerHTML += h; else lr.innerHTML += h; }); };
        window.switchDayTab = (t) => { const br=document.getElementById('tab-route'), bp=document.getElementById('tab-pickup'), cr=document.getElementById('content-route'), cp=document.getElementById('content-pickup'); if(t==='route'){ br.classList.add('active'); bp.classList.remove('active'); cr.classList.remove('hidden'); cp.classList.add('hidden'); } else { bp.classList.add('active'); br.classList.remove('active'); cp.classList.remove('hidden'); cr.classList.add('hidden'); } };
        window.resetShipView = () => { currentYear = null; currentMonth = null; document.getElementById('ship-days').classList.add('hidden'); document.getElementById('ship-months').classList.add('hidden'); document.getElementById('ship-years').classList.remove('hidden'); window.updateBreadcrumb(); };
        window.updateBreadcrumb = () => { const b = document.getElementById('ship-breadcrumb'); let h = `<span class="cursor-pointer hover:underline" onclick="resetShipView()">Inicio</span>`; if (currentYear) h += ` > ${currentYear}`; if (currentMonth !== null) h += ` > ${monthNames[currentMonth]}`; b.innerHTML = h; };

        window.switchView('dashboard');
    </script>
</body>
</html>
